# ğŸ“Š DATA FLOW DIAGRAMS - LUá»’NG Dá»® LIá»†U Há»† THá»NG

## ğŸ¯ Tá»”NG QUAN

File nÃ y mÃ´ táº£ **chi tiáº¿t luá»“ng dá»¯ liá»‡u** trong Drug Prevention Support System, giÃºp cáº£ 3 thÃ nh viÃªn hiá»ƒu rÃµ cÃ¡ch data di chuyá»ƒn tá»« Frontend â†’ Backend â†’ Database vÃ  ngÆ°á»£c láº¡i.

## ğŸ—ï¸ KIáº¾N TRÃšC LUá»’NG Dá»® LIá»†U Tá»”NG THá»‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FRONTEND LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   React     â”‚  â”‚   Axios     â”‚  â”‚   Local     â”‚  â”‚   State     â”‚ â”‚
â”‚  â”‚ Components  â”‚  â”‚  Services   â”‚  â”‚  Storage    â”‚  â”‚ Management  â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚   (useState) â”‚ â”‚
â”‚  â”‚ â€¢ Pages     â”‚  â”‚ â€¢ API calls â”‚  â”‚ â€¢ JWT token â”‚  â”‚ â€¢ Form data â”‚ â”‚
â”‚  â”‚ â€¢ Forms     â”‚  â”‚ â€¢ Error     â”‚  â”‚ â€¢ User info â”‚  â”‚ â€¢ Loading   â”‚ â”‚
â”‚  â”‚ â€¢ Tables    â”‚  â”‚   handling  â”‚  â”‚ â€¢ Cache     â”‚  â”‚ â€¢ Error     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                             HTTP/HTTPS (JSON)
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           BACKEND LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Controllers â”‚  â”‚  Services   â”‚  â”‚ Validation  â”‚  â”‚    DTOs     â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ REST APIs â”‚  â”‚ â€¢ Business  â”‚  â”‚ â€¢ Input     â”‚  â”‚ â€¢ Request   â”‚ â”‚
â”‚  â”‚ â€¢ Request   â”‚  â”‚   Logic     â”‚  â”‚   validationâ”‚  â”‚ â€¢ Response  â”‚ â”‚
â”‚  â”‚   mapping   â”‚  â”‚ â€¢ Transform â”‚  â”‚ â€¢ Security  â”‚  â”‚ â€¢ Entity    â”‚ â”‚
â”‚  â”‚ â€¢ Response  â”‚  â”‚   data      â”‚  â”‚   checks    â”‚  â”‚   mapping   â”‚ â”‚
â”‚  â”‚   building  â”‚  â”‚ â€¢ Call repo â”‚  â”‚ â€¢ Business  â”‚  â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Repositoriesâ”‚  â”‚   Entities  â”‚  â”‚   Security  â”‚  â”‚ External    â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  Services   â”‚ â”‚
â”‚  â”‚ â€¢ JPA       â”‚  â”‚ â€¢ Database  â”‚  â”‚ â€¢ JWT       â”‚  â”‚             â”‚ â”‚
â”‚  â”‚   queries   â”‚  â”‚   models    â”‚  â”‚ â€¢ Auth      â”‚  â”‚ â€¢ VNPay     â”‚ â”‚
â”‚  â”‚ â€¢ Custom    â”‚  â”‚ â€¢ Relations â”‚  â”‚ â€¢ RBAC      â”‚  â”‚ â€¢ Email     â”‚ â”‚
â”‚  â”‚   methods   â”‚  â”‚ â€¢ Mapping   â”‚  â”‚             â”‚  â”‚ â€¢ Storage   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                              JPA/Hibernate
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATABASE LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Tables    â”‚  â”‚   Indexes   â”‚  â”‚ Constraints â”‚  â”‚  Triggers   â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ users     â”‚  â”‚ â€¢ Primary   â”‚  â”‚ â€¢ Foreign   â”‚  â”‚ â€¢ Audit     â”‚ â”‚
â”‚  â”‚ â€¢ courses   â”‚  â”‚   keys      â”‚  â”‚   keys      â”‚  â”‚ â€¢ Update    â”‚ â”‚
â”‚  â”‚ â€¢ appointmentsâ”‚ â”‚ â€¢ Foreign   â”‚  â”‚ â€¢ Unique    â”‚  â”‚   timestampsâ”‚ â”‚
â”‚  â”‚ â€¢ registrationsâ”‚ â”‚ â€¢ Indexes  â”‚  â”‚ â€¢ Check     â”‚  â”‚ â€¢ Data      â”‚ â”‚
â”‚  â”‚ â€¢ payments  â”‚  â”‚ â€¢ Search    â”‚  â”‚ â€¢ Not null  â”‚  â”‚   validationâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ LUá»’NG ÄÄ‚NG NHáº¬P CHI TIáº¾T

### **Sequence Diagram:**

```
Frontend          Backend           Database          SecurityContext
   â”‚                 â”‚                 â”‚                    â”‚
   â”‚ 1. POST login   â”‚                 â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                    â”‚
   â”‚                 â”‚ 2. find user    â”‚                    â”‚
   â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
   â”‚                 â”‚ 3. user entity  â”‚                    â”‚
   â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                 â”‚ 4. validate     â”‚                    â”‚
   â”‚                 â”‚    password     â”‚                    â”‚
   â”‚                 â”‚    (BCrypt)     â”‚                    â”‚
   â”‚                 â”‚ 5. generate JWT â”‚                    â”‚
   â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                 â”‚ 6. JWT token    â”‚                    â”‚
   â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 7. login resp   â”‚                 â”‚                    â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                    â”‚
   â”‚ 8. store token  â”‚                 â”‚                    â”‚
   â”‚    localStorage â”‚                 â”‚                    â”‚
   â”‚                 â”‚                 â”‚                    â”‚
   â”‚ 9. API call     â”‚                 â”‚                    â”‚
   â”‚   with Bearer   â”‚                 â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 10. validate    â”‚                    â”‚
   â”‚                 â”‚     JWT token   â”‚                    â”‚
   â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                 â”‚ 11. set auth    â”‚                    â”‚
   â”‚                 â”‚     context     â”‚                    â”‚
   â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                 â”‚ 12. execute     â”‚                    â”‚
   â”‚                 â”‚     business    â”‚                    â”‚
   â”‚                 â”‚     logic       â”‚                    â”‚
   â”‚ 13. response    â”‚                 â”‚                    â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                    â”‚
```

### **Code Flow:**

**Frontend (LoginPage.jsx):**
```javascript
const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
        // 1. Call API service
        const { user, token } = await authService.login(formData);
        
        // 2. Store token in localStorage
        localStorage.setItem('token', token);
        localStorage.setItem('user', JSON.stringify(user));
        
        // 3. Set axios default header
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        
        // 4. Redirect based on role
        switch (user.role.name) {
            case 'ADMIN': navigate('/admin-dashboard'); break;
            case 'STAFF': navigate('/staff-dashboard'); break;
            default: navigate('/dashboard');
        }
    } catch (err) {
        setError(err.message);
    } finally {
        setLoading(false);
    }
};
```

**Backend (AuthController.java):**
```java
@PostMapping("/login")
public ResponseEntity<LoginResponse> login(@Valid @RequestBody LoginRequest loginRequest) {
    try {
        // 1. Authenticate user
        Authentication authentication = authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(
                loginRequest.getUsername(),
                loginRequest.getPassword()
            )
        );
        
        // 2. Generate JWT token
        String jwt = jwtService.generateToken(authentication);
        
        // 3. Get user details
        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
        User user = userService.findById(userPrincipal.getId());
        
        // 4. Return response
        return ResponseEntity.ok(new LoginResponse(jwt, convertToDTO(user)));
        
    } catch (BadCredentialsException e) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
            .body(new LoginResponse(null, null, "Invalid credentials"));
    }
}
```

## ğŸ“š LUá»’NG QUáº¢N LÃ KHÃ“A Há»ŒC

### **Create Course Flow:**

```
Frontend (Staff)     Backend              Database           External
     â”‚                   â”‚                    â”‚                â”‚
     â”‚ 1. Fill form      â”‚                    â”‚                â”‚
     â”‚ 2. Submit         â”‚                    â”‚                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                â”‚
     â”‚                   â”‚ 3. Validate       â”‚                â”‚
     â”‚                   â”‚    JWT & Role     â”‚                â”‚
     â”‚                   â”‚ 4. Validate       â”‚                â”‚
     â”‚                   â”‚    course data    â”‚                â”‚
     â”‚                   â”‚ 5. Check category â”‚                â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                   â”‚ 6. category found â”‚                â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
     â”‚                   â”‚ 7. Create course  â”‚                â”‚
     â”‚                   â”‚    entity         â”‚                â”‚
     â”‚                   â”‚ 8. Save to DB     â”‚                â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                   â”‚ 9. Course saved   â”‚                â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
     â”‚                   â”‚ 10. Upload image  â”‚                â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 11. Image URL     â”‚                â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚ 12. Update course â”‚                â”‚
     â”‚                   â”‚     with imageURL â”‚                â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚ 13. Success       â”‚                    â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                â”‚
```

### **Course Registration Flow:**

```
Frontend (User)      Backend              Database           Payment Gateway
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 1. Click register â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 2. Check eligibility                   â”‚
     â”‚                   â”‚    - Course open?  â”‚                    â”‚
     â”‚                   â”‚    - Available slots?                  â”‚
     â”‚                   â”‚    - Not registered?                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 3. Validation OK   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 4. Check price     â”‚                    â”‚
     â”‚                   â”‚    Free vs Paid    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ FREE COURSE:      â”‚ 5. Create active   â”‚                    â”‚
     â”‚                   â”‚    registration    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 6. Update course   â”‚                    â”‚
     â”‚                   â”‚    participant     â”‚                    â”‚
     â”‚                   â”‚    count           â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚ 7. Success        â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ PAID COURSE:      â”‚ 5. Create pending  â”‚                    â”‚
     â”‚                   â”‚    registration    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 6. Create payment  â”‚                    â”‚
     â”‚                   â”‚    entity          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 7. Generate VNPay  â”‚                    â”‚
     â”‚                   â”‚    URL             â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 8. Payment URL     â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ 9. Redirect to    â”‚                    â”‚                    â”‚
     â”‚    VNPay          â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 10. User pays     â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 11. Payment        â”‚                    â”‚
     â”‚                   â”‚     callback       â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚ 12. Update payment â”‚                    â”‚
     â”‚                   â”‚     status         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 13. Activate       â”‚                    â”‚
     â”‚                   â”‚     registration   â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚ 14. Success page  â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

## ğŸ“… LUá»’NG Äáº¶T Lá»ŠCH TÆ¯ Váº¤N

### **Appointment Booking Flow:**

```
Frontend (User)      Backend              Database           Notification
     â”‚                   â”‚                    â”‚                   â”‚
     â”‚ 1. Choose         â”‚                    â”‚                   â”‚
     â”‚    consultant     â”‚                    â”‚                   â”‚
     â”‚ 2. Select date    â”‚                    â”‚                   â”‚
     â”‚ 3. Request        â”‚                    â”‚                   â”‚
     â”‚    available slotsâ”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 4. Query booked    â”‚                   â”‚
     â”‚                   â”‚    slots for date  â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
     â”‚                   â”‚ 5. Booked times    â”‚                   â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚ 6. Calculate       â”‚                   â”‚
     â”‚                   â”‚    available slots â”‚                   â”‚
     â”‚ 7. Available      â”‚    (8AM-5PM minus  â”‚                   â”‚
     â”‚    times          â”‚     booked times)  â”‚                   â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚
     â”‚ 8. Select time    â”‚                    â”‚                   â”‚
     â”‚ 9. Fill details   â”‚                    â”‚                   â”‚
     â”‚ 10. Submit        â”‚                    â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 11. Validate       â”‚                   â”‚
     â”‚                   â”‚     - Time future? â”‚                   â”‚
     â”‚                   â”‚     - Within hours?â”‚                   â”‚
     â”‚                   â”‚     - Not conflict?â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
     â”‚                   â”‚ 12. Validation OK  â”‚                   â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚ 13. Create         â”‚                   â”‚
     â”‚                   â”‚     appointment    â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
     â”‚                   â”‚ 14. Appointment    â”‚                   â”‚
     â”‚                   â”‚     created        â”‚                   â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚ 15. Send email     â”‚                   â”‚
     â”‚                   â”‚     notifications  â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚ 16. Success       â”‚                    â”‚                   â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                   â”‚
```

### **Appointment Management States:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SCHEDULED    â”‚ â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚       â”‚
â”‚ Initial state   â”‚       â”‚ User/Consultant
â”‚ when created    â”‚       â”‚ can reschedule
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚               â”‚
          â”‚ Consultant    â”‚
          â”‚ completes     â”‚
          â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    COMPLETED    â”‚       â”‚
â”‚                 â”‚       â”‚
â”‚ Session done    â”‚       â”‚
â”‚ Review prompt   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚               â”‚
          â”‚ User submits  â”‚
          â”‚ review        â”‚
          â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    REVIEWED     â”‚       â”‚
â”‚                 â”‚       â”‚
â”‚ Final state     â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                          â”‚
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   RESCHEDULED   â”‚
                 â”‚                 â”‚
                 â”‚ New time set    â”‚
                 â”‚ Becomes         â”‚
                 â”‚ SCHEDULED       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Can also be
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚    CANCELLED    â”‚
                 â”‚                 â”‚
                 â”‚ Final state     â”‚
                 â”‚ No further      â”‚
                 â”‚ actions         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’³ LUá»’NG THANH TOÃN VNPAY

### **Payment Process Flow:**

```
Frontend         Backend           Database         VNPay Gateway
   â”‚                â”‚                 â”‚                   â”‚
   â”‚ 1. Register    â”‚                 â”‚                   â”‚
   â”‚    paid course â”‚                 â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 2. Create       â”‚                   â”‚
   â”‚                â”‚    pending      â”‚                   â”‚
   â”‚                â”‚    registration â”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚                â”‚ 3. Create       â”‚                   â”‚
   â”‚                â”‚    payment      â”‚                   â”‚
   â”‚                â”‚    record       â”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚                â”‚ 4. Generate     â”‚                   â”‚
   â”‚                â”‚    VNPay params â”‚                   â”‚
   â”‚                â”‚    + signature  â”‚                   â”‚
   â”‚                â”‚ 5. Build        â”‚                   â”‚
   â”‚                â”‚    payment URL  â”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚ 6. Payment URL â”‚                 â”‚                   â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                   â”‚
   â”‚                â”‚                 â”‚                   â”‚
   â”‚ 7. Redirect    â”‚                 â”‚                   â”‚
   â”‚    to VNPay    â”‚                 â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                â”‚                 â”‚                   â”‚
   â”‚ 8. User pays   â”‚                 â”‚                   â”‚
   â”‚    on VNPay    â”‚                 â”‚                   â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                â”‚                 â”‚                   â”‚
   â”‚                â”‚ 9. Payment      â”‚                   â”‚
   â”‚                â”‚    callback     â”‚                   â”‚
   â”‚                â”‚    with result  â”‚                   â”‚
   â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                â”‚ 10. Validate    â”‚                   â”‚
   â”‚                â”‚     signature   â”‚                   â”‚
   â”‚                â”‚     + response  â”‚                   â”‚
   â”‚                â”‚ 11. Update      â”‚                   â”‚
   â”‚                â”‚     payment     â”‚                   â”‚
   â”‚                â”‚     status      â”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚                â”‚ 12. If success: â”‚                   â”‚
   â”‚                â”‚     Activate    â”‚                   â”‚
   â”‚                â”‚     registrationâ”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚                â”‚ 13. Update      â”‚                   â”‚
   â”‚                â”‚     course      â”‚                   â”‚
   â”‚                â”‚     participant â”‚                   â”‚
   â”‚                â”‚     count       â”‚                   â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚ 14. Redirect   â”‚                 â”‚                   â”‚
   â”‚     to result  â”‚                 â”‚                   â”‚
   â”‚     page       â”‚                 â”‚                   â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                   â”‚
```

### **VNPay Callback Handler:**

```java
@PostMapping("/vnpay-callback")
public ResponseEntity<String> vnpayCallback(@RequestParam Map<String, String> params) {
    try {
        // 1. Validate signature
        boolean isValidSignature = vnPayService.validateSignature(params);
        if (!isValidSignature) {
            logger.error("Invalid VNPay signature");
            return ResponseEntity.badRequest().body("Invalid signature");
        }
        
        // 2. Get payment info
        String txnRef = params.get("vnp_TxnRef");
        String responseCode = params.get("vnp_ResponseCode");
        String amount = params.get("vnp_Amount");
        
        // 3. Find payment record
        Payment payment = paymentService.findByTransactionRef(txnRef);
        if (payment == null) {
            logger.error("Payment not found for txnRef: {}", txnRef);
            return ResponseEntity.badRequest().body("Payment not found");
        }
        
        // 4. Update payment status
        if ("00".equals(responseCode)) {
            // Success
            paymentService.markAsCompleted(payment.getId(), params);
            
            // Activate course registration
            courseRegistrationService.activateRegistration(payment.getCourseRegistration().getId());
            
            // Send success notification
            notificationService.sendPaymentSuccessNotification(payment);
            
        } else {
            // Failed
            paymentService.markAsFailed(payment.getId(), responseCode);
            
            // Send failure notification
            notificationService.sendPaymentFailureNotification(payment);
        }
        
        return ResponseEntity.ok("Success");
        
    } catch (Exception e) {
        logger.error("Error processing VNPay callback", e);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Error");
    }
}
```

## ğŸ“Š DATABASE RELATIONSHIPS

### **Entity Relationship Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ROLES      â”‚       â”‚     USERS       â”‚       â”‚   CATEGORIES    â”‚
â”‚                 â”‚       â”‚                 â”‚       â”‚                 â”‚
â”‚ â€¢ id (PK)       â”‚â—€â”€â”€â”€â”€â”€â”€â”‚ â€¢ id (PK)       â”‚       â”‚ â€¢ id (PK)       â”‚
â”‚ â€¢ name          â”‚       â”‚ â€¢ username      â”‚       â”‚ â€¢ name          â”‚
â”‚ â€¢ description   â”‚       â”‚ â€¢ password      â”‚       â”‚ â€¢ description   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â€¢ email         â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ â€¢ full_name     â”‚                 â”‚
                          â”‚ â€¢ role_id (FK)  â”‚                 â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                    â”‚                         â”‚
                                    â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚                         â”‚
â”‚   APPOINTMENTS  â”‚                 â”‚                         â”‚
â”‚                 â”‚                 â”‚                         â”‚
â”‚ â€¢ id (PK)       â”‚                 â”‚                         â”‚
â”‚ â€¢ user_id (FK)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚ â€¢ consultant_id â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚ â€¢ appointment_  â”‚                 â”‚                         â”‚
â”‚   time          â”‚                 â–¼                         â”‚
â”‚ â€¢ type          â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â€¢ status        â”‚       â”‚    COURSES      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ notes         â”‚       â”‚                 â”‚
â”‚ â€¢ created_at    â”‚       â”‚ â€¢ id (PK)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â€¢ title         â”‚
          â”‚               â”‚ â€¢ description   â”‚
          â”‚               â”‚ â€¢ instructor_id â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚   (FK)          â”‚                 â”‚
          â”‚               â”‚ â€¢ category_id   â”‚                 â”‚
          â”‚               â”‚   (FK)          â”‚                 â–¼
          â”‚               â”‚ â€¢ price         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚ â€¢ duration_weeksâ”‚       â”‚    (USERS)      â”‚
          â”‚               â”‚ â€¢ max_participants      â”‚  INSTRUCTORS    â”‚
          â”‚               â”‚ â€¢ current_participants  â”‚                 â”‚
          â”‚               â”‚ â€¢ status        â”‚       â”‚ â€¢ role = STAFF  â”‚
          â”‚               â”‚ â€¢ is_featured   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚
          â”‚                         â”‚
          â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    REVIEWS      â”‚       â”‚ COURSE_         â”‚
â”‚                 â”‚       â”‚ REGISTRATIONS   â”‚
â”‚ â€¢ id (PK)       â”‚       â”‚                 â”‚
â”‚ â€¢ appointment_  â”‚       â”‚ â€¢ user_id (PK)  â”‚
â”‚   id (FK)       â”‚       â”‚ â€¢ course_id     â”‚
â”‚ â€¢ user_id (FK)  â”‚       â”‚   (PK)          â”‚
â”‚ â€¢ consultant_id â”‚       â”‚ â€¢ registration_ â”‚
â”‚   (FK)          â”‚       â”‚   date          â”‚
â”‚ â€¢ rating        â”‚       â”‚ â€¢ status        â”‚
â”‚ â€¢ comment       â”‚       â”‚ â€¢ progress      â”‚
â”‚ â€¢ created_at    â”‚       â”‚ â€¢ completion_   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   date          â”‚
                          â”‚ â€¢ payment_id    â”‚
                          â”‚   (FK)          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    PAYMENTS     â”‚
                          â”‚                 â”‚
                          â”‚ â€¢ id (PK)       â”‚
                          â”‚ â€¢ user_id (FK)  â”‚
                          â”‚ â€¢ amount        â”‚
                          â”‚ â€¢ currency      â”‚
                          â”‚ â€¢ status        â”‚
                          â”‚ â€¢ payment_methodâ”‚
                          â”‚ â€¢ vnp_transaction_id
                          â”‚ â€¢ created_at    â”‚
                          â”‚ â€¢ payment_date  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” DATA VALIDATION LAYERS

### **Multi-Layer Validation:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND VALIDATION                     â”‚
â”‚                                                             â”‚
â”‚ â€¢ Form validation (React)                                  â”‚
â”‚ â€¢ Real-time field validation                               â”‚
â”‚ â€¢ Client-side business rules                               â”‚
â”‚ â€¢ User experience improvements                              â”‚
â”‚                                                             â”‚
â”‚ Example: Required fields, email format, date ranges        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTROLLER VALIDATION                   â”‚
â”‚                                                             â”‚
â”‚ â€¢ @Valid annotation on DTOs                                â”‚
â”‚ â€¢ Bean Validation (JSR-303)                                â”‚
â”‚ â€¢ Request format validation                                 â”‚
â”‚ â€¢ Authentication & Authorization                            â”‚
â”‚                                                             â”‚
â”‚ Example: @NotNull, @Size, @Email, @Pattern                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVICE VALIDATION                     â”‚
â”‚                                                             â”‚
â”‚ â€¢ Business logic validation                                 â”‚
â”‚ â€¢ Cross-entity validation                                   â”‚
â”‚ â€¢ Complex business rules                                    â”‚
â”‚ â€¢ Security checks                                           â”‚
â”‚                                                             â”‚
â”‚ Example: Appointment time conflicts, course capacity       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE VALIDATION                     â”‚
â”‚                                                             â”‚
â”‚ â€¢ Foreign key constraints                                   â”‚
â”‚ â€¢ Unique constraints                                        â”‚
â”‚ â€¢ Check constraints                                         â”‚
â”‚ â€¢ Data type enforcement                                     â”‚
â”‚                                                             â”‚
â”‚ Example: NOT NULL, UNIQUE, FOREIGN KEY, CHECK              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ PERFORMANCE CONSIDERATIONS

### **Data Flow Optimization:**

**1. Database Queries:**
```java
// âŒ N+1 Query Problem
List<Course> courses = courseRepository.findAll();
for (Course course : courses) {
    course.getInstructor().getFullName(); // Lazy loading trigger
}

// âœ… Fetch Join Solution
@Query("SELECT c FROM Course c JOIN FETCH c.instructor JOIN FETCH c.category")
List<Course> findAllWithInstructorAndCategory();

// âœ… DTO Projection Solution
@Query("SELECT new com.drugprevention.dto.CourseListDTO(c.id, c.title, c.price, i.fullName) " +
       "FROM Course c JOIN c.instructor i")
List<CourseListDTO> findAllCourseListDTOs();
```

**2. Caching Strategy:**
```java
// Service level caching
@Cacheable(value = "courses", key = "'featured'")
public List<Course> getFeaturedCourses() {
    return courseRepository.findByIsFeaturedTrue();
}

@CacheEvict(value = "courses", allEntries = true)
public Course updateCourse(Long id, Course course) {
    // Cache invalidation on update
}
```

**3. Pagination:**
```java
// Backend pagination
@GetMapping("/courses")
public ResponseEntity<Page<Course>> getCourses(
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "12") int size,
    @RequestParam(defaultValue = "createdAt") String sortBy) {
    
    Pageable pageable = PageRequest.of(page, size, Sort.by(sortBy).descending());
    Page<Course> courses = courseService.findAll(pageable);
    return ResponseEntity.ok(courses);
}
```

**Frontend pagination:**
```javascript
const [pagination, setPagination] = useState({
    page: 0,
    size: 12,
    totalElements: 0,
    totalPages: 0
});

const fetchCourses = async () => {
    const response = await courseService.getCourses({
        page: pagination.page,
        size: pagination.size,
        ...filters
    });
    
    setCourses(response.content);
    setPagination({
        page: response.number,
        size: response.size,
        totalElements: response.totalElements,
        totalPages: response.totalPages
    });
};
```

## ğŸ¯ DATA CONSISTENCY & TRANSACTIONS

### **Transaction Management:**

```java
@Transactional
public CourseRegistration registerForCourse(Long courseId, String username) {
    // 1. Lock course for update Ä‘á»ƒ trÃ¡nh race condition
    Course course = courseRepository.findByIdForUpdate(courseId);
    
    // 2. Check capacity
    if (course.getCurrentParticipants() >= course.getMaxParticipants()) {
        throw new CourseFullException("Course is full");
    }
    
    // 3. Create registration
    CourseRegistration registration = new CourseRegistration();
    // ... set properties
    
    // 4. Save registration
    courseRegistrationRepository.save(registration);
    
    // 5. Update course participant count
    course.setCurrentParticipants(course.getCurrentParticipants() + 1);
    courseRepository.save(course);
    
    // 6. Send notification (could be async)
    applicationEventPublisher.publishEvent(new CourseRegisteredEvent(registration));
    
    return registration;
}
```

### **Event-Driven Updates:**

```java
@EventListener
@Async
public void handleCourseRegistered(CourseRegisteredEvent event) {
    // Send welcome email
    emailService.sendCourseWelcomeEmail(event.getRegistration());
    
    // Update statistics
    statisticsService.updateCourseStats(event.getRegistration().getCourse().getId());
    
    // Log activity
    auditService.logCourseRegistration(event.getRegistration());
}
```

---

**ğŸ”¥ QUAN TRá»ŒNG CHO HIá»†U SUáº¤T:**
- LuÃ´n sá»­ dá»¥ng pagination cho large datasets
- Implement proper database indexing
- Use DTOs Ä‘á»ƒ giáº£m data transfer
- Cache frequently accessed data
- Monitor database query performance
- Optimize N+1 query problems
- Use async processing cho non-critical operations 