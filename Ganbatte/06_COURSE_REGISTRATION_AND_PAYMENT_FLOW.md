# LUá»’NG ÄÄ‚NG KÃ KHÃ“A Há»ŒC VÃ€ THANH TOÃN CHI TIáº¾T

## ğŸ“‹ Tá»”NG QUAN LUá»’NG Há»† THá»NG

Há»‡ thá»‘ng há»— trá»£ 2 loáº¡i khÃ³a há»c:
- **KhÃ³a há»c miá»…n phÃ­**: ÄÄƒng kÃ½ trá»±c tiáº¿p, khÃ´ng cáº§n thanh toÃ¡n
- **KhÃ³a há»c cÃ³ phÃ­**: YÃªu cáº§u thanh toÃ¡n qua VNPay trÆ°á»›c khi cáº¥p quyá»n truy cáº­p

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG ÄÄ‚NG KÃ KHÃ“A Há»ŒC

```
Frontend (User)      Backend              Database           VNPay Gateway
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 1. Click Enroll   â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 2. Check Auth      â”‚                    â”‚
     â”‚                   â”‚    & User Info     â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 3. User Found      â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 4. Get Course      â”‚                    â”‚
     â”‚                   â”‚    Details         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 5. Course Info     â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 6. Validate        â”‚                    â”‚
     â”‚                   â”‚    Registration    â”‚                    â”‚
     â”‚                   â”‚    Conditions      â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 7. Check if        â”‚                    â”‚
     â”‚                   â”‚    Already         â”‚                    â”‚
     â”‚                   â”‚    Registered      â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 8. Not Registered  â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 9. Check Course    â”‚                    â”‚
     â”‚                   â”‚    Capacity        â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 10. Capacity OK    â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 11. Check Price    â”‚                    â”‚
     â”‚                   â”‚    Free vs Paid    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ FREE COURSE:      â”‚ 12. Create Active  â”‚                    â”‚
     â”‚                   â”‚    Registration    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 13. Update Course  â”‚                    â”‚
     â”‚                   â”‚    Participants    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚ 14. Success       â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ PAID COURSE:      â”‚ 12. Return Payment â”‚                    â”‚
     â”‚                   â”‚    Required        â”‚                    â”‚
     â”‚ 13. Payment Info  â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 14. Create VNPay  â”‚                    â”‚                    â”‚
     â”‚    Payment        â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 15. Create Payment â”‚                    â”‚
     â”‚                   â”‚    Record          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 16. Generate VNPay â”‚                    â”‚
     â”‚                   â”‚    Parameters      â”‚                    â”‚
     â”‚                   â”‚ 17. Build Payment  â”‚                    â”‚
     â”‚                   â”‚    URL with        â”‚                    â”‚
     â”‚                   â”‚    Signature       â”‚                    â”‚
     â”‚                   â”‚ 18. Store Payment  â”‚                    â”‚
     â”‚                   â”‚    URL             â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚ 19. Payment URL   â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 20. Redirect to   â”‚                    â”‚                    â”‚
     â”‚    VNPay Portal   â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 21. User pays on  â”‚                    â”‚                    â”‚
     â”‚    VNPay          â”‚                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 22. VNPay         â”‚                    â”‚                    â”‚
     â”‚    Callback       â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 23. Validate       â”‚                    â”‚
     â”‚                   â”‚    Signature       â”‚                    â”‚
     â”‚                   â”‚ 24. Update Payment â”‚                    â”‚
     â”‚                   â”‚    Status          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 25. Create Course  â”‚                    â”‚
     â”‚                   â”‚    Registration    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 26. Update Course  â”‚                    â”‚
     â”‚                   â”‚    Participants    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚ 27. Success       â”‚                    â”‚                    â”‚
     â”‚    Redirect       â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG Xá»¬ LÃ Lá»–I CHI TIáº¾T

```
Frontend (User)      Backend              Database           VNPay Gateway
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 1. Click Enroll   â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 2. Check Auth      â”‚                    â”‚
     â”‚                   â”‚    & User Info     â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 3. User Not Found  â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 4. Error:         â”‚                    â”‚                    â”‚
     â”‚    Auth Required  â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 5. Login & Retry  â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 6. Get Course      â”‚                    â”‚
     â”‚                   â”‚    Details         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 7. Course Not      â”‚                    â”‚
     â”‚                   â”‚    Found           â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 8. Error:         â”‚                    â”‚                    â”‚
     â”‚    Course Not     â”‚                    â”‚                    â”‚
     â”‚    Found          â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 9. Check Course   â”‚                    â”‚                    â”‚
     â”‚    Status         â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 10. Course         â”‚                    â”‚
     â”‚                   â”‚     Inactive       â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 11. Error:        â”‚                    â”‚                    â”‚
     â”‚     Course Not    â”‚                    â”‚                    â”‚
     â”‚     Available     â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 12. Check         â”‚                    â”‚                    â”‚
     â”‚     Already       â”‚                    â”‚                    â”‚
     â”‚     Registered    â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 13. Already        â”‚                    â”‚
     â”‚                   â”‚     Registered     â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 14. Error:        â”‚                    â”‚                    â”‚
     â”‚     Already       â”‚                    â”‚                    â”‚
     â”‚     Enrolled      â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 15. Check         â”‚                    â”‚                    â”‚
     â”‚     Capacity      â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 16. Course Full    â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 17. Error:        â”‚                    â”‚                    â”‚
     â”‚     Course Full   â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG VNPAY INTEGRATION CHI TIáº¾T

```
Frontend (User)      Backend              VNPay Service      VNPay Gateway
     â”‚                   â”‚                       â”‚                    â”‚
     â”‚ 1. Create Payment â”‚                       â”‚                    â”‚
     â”‚    Request        â”‚                       â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                    â”‚
     â”‚                   â”‚ 2. Create Payment    â”‚                    â”‚
     â”‚                   â”‚    Entity             â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 3. Payment Created    â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 4. Build VNPay        â”‚                    â”‚
     â”‚                   â”‚    Parameters         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 5. Add Required       â”‚                    â”‚
     â”‚                   â”‚    Fields             â”‚                    â”‚
     â”‚                   â”‚    - vnp_Version      â”‚                    â”‚
     â”‚                   â”‚    - vnp_Command      â”‚                    â”‚
     â”‚                   â”‚    - vnp_TmnCode      â”‚                    â”‚
     â”‚                   â”‚    - vnp_CurrCode     â”‚                    â”‚
     â”‚                   â”‚    - vnp_Locale       â”‚                    â”‚
     â”‚                   â”‚    - vnp_ReturnUrl    â”‚                    â”‚
     â”‚                   â”‚    - vnp_IpAddr       â”‚                    â”‚
     â”‚                   â”‚    - vnp_CreateDate   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 6. Sort Parameters    â”‚                    â”‚
     â”‚                   â”‚    Alphabetically     â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 7. Build Hash Data    â”‚                    â”‚
     â”‚                   â”‚    String             â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 8. Generate HMAC      â”‚                    â”‚
     â”‚                   â”‚    SHA512 Signature   â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 9. Signature          â”‚                    â”‚
     â”‚                   â”‚    Generated          â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 10. Build Final URL   â”‚                    â”‚
     â”‚                   â”‚     with Signature    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 11. Payment URL       â”‚                    â”‚
     â”‚                   â”‚     Ready             â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 12. Payment URL   â”‚                       â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
     â”‚                   â”‚                       â”‚                    â”‚
     â”‚ 13. Redirect to   â”‚                       â”‚                    â”‚
     â”‚     VNPay         â”‚                       â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚                       â”‚                    â”‚
     â”‚ 14. User Payment  â”‚                       â”‚                    â”‚
     â”‚     Process       â”‚                       â”‚                    â”‚
     â”‚                   â”‚                       â”‚                    â”‚
     â”‚ 15. VNPay         â”‚                       â”‚                    â”‚
     â”‚     Callback      â”‚                       â”‚                    â”‚
     â”‚                   â”‚ 16. Validate          â”‚                    â”‚
     â”‚                   â”‚     Signature         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 17. Signature Valid   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 18. Process Response  â”‚                    â”‚
     â”‚                   â”‚     Code              â”‚                    â”‚
     â”‚                   â”‚ 19. Update Payment    â”‚                    â”‚
     â”‚                   â”‚     Status            â”‚                    â”‚
     â”‚                   â”‚ 20. Create Course     â”‚                    â”‚
     â”‚                   â”‚     Registration      â”‚                    â”‚
     â”‚                   â”‚ 21. Redirect User     â”‚                    â”‚
     â”‚                   â”‚     to Success Page   â”‚                    â”‚
     â”‚ 22. Success Page  â”‚                       â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                    â”‚
```

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG DATABASE TRANSACTION

```
CourseRegistrationController    CourseRegistrationService    Database
           â”‚                              â”‚                      â”‚
           â”‚ 1. registerForCourse()       â”‚                      â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
           â”‚                              â”‚ 2. @Transactional    â”‚
           â”‚                              â”‚    begin             â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 3. Find User         â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 4. User Data         â”‚
           â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                              â”‚ 5. Find Course       â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 6. Course Data       â”‚
           â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                              â”‚ 7. Check Existing    â”‚
           â”‚                              â”‚    Registration      â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 8. Registration      â”‚
           â”‚                              â”‚    Status            â”‚
           â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                              â”‚ 9. Create New        â”‚
           â”‚                              â”‚    Registration      â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 10. Registration     â”‚
           â”‚                              â”‚     Saved            â”‚
           â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                              â”‚ 11. Update Course    â”‚
           â”‚                              â”‚     Participants     â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 12. Course Updated   â”‚
           â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚                              â”‚ 13. @Transactional   â”‚
           â”‚                              â”‚     commit           â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚ 14. Registration Success     â”‚                      â”‚
           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
           â”‚                              â”‚                      â”‚
           â”‚                              â”‚                      â”‚
           â”‚ ERROR SCENARIO:              â”‚                      â”‚
           â”‚                              â”‚                      â”‚
           â”‚ 15. registerForCourse()      â”‚                      â”‚
           â”‚     (with error)             â”‚                      â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
           â”‚                              â”‚ 16. @Transactional   â”‚
           â”‚                              â”‚     begin            â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚                              â”‚ 17. Validation       â”‚
           â”‚                              â”‚     Error            â”‚
           â”‚                              â”‚ 18. @Transactional   â”‚
           â”‚                              â”‚     rollback         â”‚
           â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
           â”‚ 19. Error Response           â”‚                      â”‚
           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
```

---

## ğŸ”„ FLOWCHART - LUá»’NG QUYáº¾T Äá»ŠNH ÄÄ‚NG KÃ KHÃ“A Há»ŒC

```
                    START
                       â”‚
                       â–¼
              [User Click Enroll]
                       â”‚
                       â–¼
              [Check Authentication]
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Is Logged     â”‚
              â”‚     In?         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€ NO â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                  â–¼
    [Redirect to Login]    [Get User Info]
              â”‚                  â”‚
              â”‚                  â–¼
              â”‚            [Get Course Info]
              â”‚                  â”‚
              â”‚                  â–¼
              â”‚            [Validate Course]
              â”‚                  â”‚
              â”‚                  â–¼
              â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚        â”‚   Course        â”‚
              â”‚        â”‚   Exists?       â”‚
              â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                  â”‚
              â”‚            â”Œâ”€â”€â”€â”€â”€ NO â”€â”€â”€â”€â”€â”
              â”‚            â–¼              â–¼
              â”‚    [Error: Course     [Check Course
              â”‚     Not Found]        Status]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚        â”‚   Course        â”‚
              â”‚            â”‚        â”‚   Active?       â”‚
              â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚              â”‚
              â”‚            â”‚            NO â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚    [Error: Course
              â”‚            â”‚     Not Available]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        [Check Already
              â”‚            â”‚         Registered]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚        â”‚   Already       â”‚
              â”‚            â”‚        â”‚   Registered?   â”‚
              â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚              â”‚
              â”‚            â”‚            YESâ”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚    [Error: Already
              â”‚            â”‚     Enrolled]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        [Check Course
              â”‚            â”‚         Capacity]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚        â”‚   Course        â”‚
              â”‚            â”‚        â”‚   Full?         â”‚
              â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚              â”‚
              â”‚            â”‚            YESâ”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚    [Error: Course
              â”‚            â”‚     Full]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        [Check Course
              â”‚            â”‚         Price]
              â”‚            â”‚              â”‚
              â”‚            â”‚              â–¼
              â”‚            â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚        â”‚   Free Course?  â”‚
              â”‚            â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚              â”‚
              â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€ YES â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚    â–¼                  â–¼
              â”‚            â”‚[Direct Registration] [Payment Required]
              â”‚            â”‚    â”‚                  â”‚
              â”‚            â”‚    â–¼                  â–¼
              â”‚            â”‚[Create Registration] [Create Payment]
              â”‚            â”‚    â”‚                  â”‚
              â”‚            â”‚    â–¼                  â–¼
              â”‚            â”‚[Update Participants] [Generate VNPay URL]
              â”‚            â”‚    â”‚                  â”‚
              â”‚            â”‚    â–¼                  â–¼
              â”‚            â”‚[Success Message]   [Redirect to VNPay]
              â”‚            â”‚    â”‚                  â”‚
              â”‚            â”‚    â–¼                  â–¼
              â”‚            â”‚   END              [User Payment]
              â”‚            â”‚                      â”‚
              â”‚            â”‚                      â–¼
              â”‚            â”‚              [VNPay Callback]
              â”‚            â”‚                      â”‚
              â”‚            â”‚                      â–¼
              â”‚            â”‚              [Validate Payment]
              â”‚            â”‚                      â”‚
              â”‚            â”‚                      â–¼
              â”‚            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚              â”‚   Payment       â”‚
              â”‚            â”‚              â”‚   Success?      â”‚
              â”‚            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚                      â”‚
              â”‚            â”‚              â”Œâ”€â”€â”€â”€â”€ NO â”€â”€â”€â”€â”€â”
              â”‚            â”‚              â–¼              â–¼
              â”‚            â”‚    [Payment Failed]   [Create Registration]
              â”‚            â”‚              â”‚              â”‚
              â”‚            â”‚              â–¼              â–¼
              â”‚            â”‚    [Error Message]   [Update Participants]
              â”‚            â”‚              â”‚              â”‚
              â”‚            â”‚              â–¼              â–¼
              â”‚            â”‚             END        [Success Message]
              â”‚            â”‚                          â”‚
              â”‚            â”‚                          â–¼
              â”‚            â”‚                         END
              â”‚            â”‚
              â–¼            â–¼
             END          END
```

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG REFUND VÃ€ Há»¦Y ÄÄ‚NG KÃ

```
Frontend (User)      Backend              Database           VNPay Gateway
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 1. Request Refund â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 2. Validate        â”‚                    â”‚
     â”‚                   â”‚    Payment         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 3. Payment Found   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 4. Check Refund    â”‚                    â”‚
     â”‚                   â”‚    Eligibility     â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 5. Eligible for    â”‚                    â”‚
     â”‚                   â”‚    Refund          â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 6. Cancel Course   â”‚                    â”‚
     â”‚                   â”‚    Registration    â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 7. Registration    â”‚                    â”‚
     â”‚                   â”‚    Cancelled       â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 8. Update Payment  â”‚                    â”‚
     â”‚                   â”‚    Status          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 9. Payment         â”‚                    â”‚
     â”‚                   â”‚    Updated         â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 10. Process VNPay  â”‚                    â”‚
     â”‚                   â”‚     Refund         â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 11. Refund         â”‚                    â”‚
     â”‚                   â”‚     Processed      â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ 12. Refund        â”‚                    â”‚                    â”‚
     â”‚     Success       â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

---

## ğŸ”„ SEQUENCE DIAGRAM - LUá»’NG MONITORING VÃ€ LOGGING

```
Frontend (User)      Backend              Database           Log System
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 1. User Action    â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 2. Log User        â”‚                    â”‚
     â”‚                   â”‚    Action          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 3. Action Logged   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚ 4. Process         â”‚                    â”‚
     â”‚                   â”‚    Business Logic  â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 5. Database        â”‚                    â”‚
     â”‚                   â”‚    Operation       â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 6. Operation       â”‚                    â”‚
     â”‚                   â”‚    Result          â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                   â”‚ 7. Log Operation   â”‚                    â”‚
     â”‚                   â”‚    Result          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 8. Result Logged   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚ 9. Update Metrics  â”‚                    â”‚
     â”‚                   â”‚    (if needed)     â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
     â”‚                   â”‚ 10. Metrics        â”‚                    â”‚
     â”‚                   â”‚     Updated        â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ 11. Response      â”‚                    â”‚                    â”‚
     â”‚     to User       â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ ERROR SCENARIO:   â”‚                    â”‚                    â”‚
     â”‚                   â”‚                    â”‚                    â”‚
     â”‚ 12. Error         â”‚                    â”‚                    â”‚
     â”‚     Occurs        â”‚                    â”‚                    â”‚
     â”‚                   â”‚ 13. Log Error      â”‚                    â”‚
     â”‚                   â”‚     Details        â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                   â”‚ 14. Error Logged   â”‚                    â”‚
     â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚ 15. Send Error     â”‚                    â”‚
     â”‚                   â”‚     Alert          â”‚                    â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚ 16. Error         â”‚                    â”‚                    â”‚
     â”‚     Response      â”‚                    â”‚                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
```

---

## ğŸ“ CÃC FILE CODE CHÃNH VÃ€ LUá»’NG THá»°C THI

### **1. FRONTEND - TRIGGER ÄÄ‚NG KÃ**

#### **File: `frontend/src/pages/CoursesPage.jsx`**
- **Method: `handleEnroll(courseId)`** (dÃ²ng 160-200)
  - Kiá»ƒm tra authentication
  - Gá»i `courseService.handleCourseEnrollment(courseId)`
  - Xá»­ lÃ½ response: free course vs paid course
  - Hiá»ƒn thá»‹ payment modal náº¿u cáº§n thanh toÃ¡n

#### **File: `frontend/src/services/courseService.js`**
- **Method: `handleCourseEnrollment(courseId)`** (dÃ²ng 188-225)
  - Gá»i API Ä‘Äƒng kÃ½ khÃ³a há»c
  - PhÃ¢n tÃ­ch response Ä‘á»ƒ xÃ¡c Ä‘á»‹nh free/paid
  - Tráº£ vá» payment info náº¿u cáº§n thanh toÃ¡n

- **Method: `registerForCourse(courseId)`** (dÃ²ng 132-141)
  - Gá»i API `POST /api/course-registrations/register/{courseId}`
  - Xá»­ lÃ½ response tá»« backend

### **2. BACKEND - Xá»¬ LÃ ÄÄ‚NG KÃ**

#### **File: `backend/src/main/java/com/drugprevention/drugbe/controller/CourseRegistrationController.java`**

- **Method: `registerForCourse(courseId, authentication)`** (dÃ²ng 40-120)
  - **BÆ°á»›c 1**: Validate authentication
  - **BÆ°á»›c 2**: TÃ¬m user tá»« database
  - **BÆ°á»›c 3**: Láº¥y thÃ´ng tin khÃ³a há»c
  - **BÆ°á»›c 4**: Kiá»ƒm tra Ä‘iá»u kiá»‡n Ä‘Äƒng kÃ½:
    - KhÃ³a há»c cÃ³ active khÃ´ng?
    - User Ä‘Ã£ Ä‘Äƒng kÃ½ chÆ°a?
    - CÃ²n chá»— trá»‘ng khÃ´ng?
  - **BÆ°á»›c 5**: PhÃ¢n loáº¡i khÃ³a há»c:
    - **FREE COURSE**: Táº¡o registration trá»±c tiáº¿p
    - **PAID COURSE**: Tráº£ vá» payment required

#### **File: `backend/src/main/java/com/drugprevention/drugbe/service/CourseRegistrationService.java`**

- **Method: `registerForCourse(userId, courseId)`** (dÃ²ng 25-85)
  - Validate user vÃ  course tá»“n táº¡i
  - Kiá»ƒm tra Ä‘iá»u kiá»‡n Ä‘Äƒng kÃ½
  - Táº¡o CourseRegistration entity
  - Cáº­p nháº­t sá»‘ lÆ°á»£ng participants
  - LÆ°u vÃ o database

### **3. LUá»’NG THANH TOÃN VNPAY**

#### **File: `frontend/src/services/paymentService.js`**

- **Method: `createCoursePayment(courseId, amount, description)`** (dÃ²ng 5-60)
  - Táº¡o payment request vá»›i thÃ´ng tin khÃ³a há»c
  - Gá»i API `POST /api/payments/vnpay/create`
  - Nháº­n payment URL tá»« backend

- **Method: `redirectToPayment(paymentUrl)`** (dÃ²ng 84+)
  - Redirect user Ä‘áº¿n VNPay portal

#### **File: `backend/src/main/java/com/drugprevention/drugbe/controller/PaymentController.java`**

- **Method: `createVnPayPayment(request, principal)`** (dÃ²ng 35-90)
  - **BÆ°á»›c 1**: Táº¡o Payment entity vá»›i status "PENDING"
  - **BÆ°á»›c 2**: LÆ°u payment vÃ o database
  - **BÆ°á»›c 3**: Táº¡o VNPay parameters
  - **BÆ°á»›c 4**: Gá»i VnPayService Ä‘á»ƒ táº¡o payment URL
  - **BÆ°á»›c 5**: Tráº£ vá» payment URL cho frontend

#### **File: `backend/src/main/java/com/drugprevention/drugbe/service/VnPayService.java`**

- **Method: `createPaymentUrl(params)`** (dÃ²ng 15-70)
  - Táº¡o VNPay parameters theo chuáº©n
  - Táº¡o HMAC SHA512 signature
  - Build payment URL vá»›i signature
  - Tráº£ vá» URL hoÃ n chá»‰nh

### **4. CALLBACK VÃ€ HOÃ€N THÃ€NH THANH TOÃN**

#### **File: `backend/src/main/java/com/drugprevention/drugbe/controller/PaymentController.java`**

- **Method: `handleVnPayCallback(params)`** (dÃ²ng 252-275)
  - **BÆ°á»›c 1**: Validate VNPay signature
  - **BÆ°á»›c 2**: Kiá»ƒm tra response code
  - **BÆ°á»›c 3**: Cáº­p nháº­t payment status
  - **BÆ°á»›c 4**: Táº¡o course registration náº¿u thÃ nh cÃ´ng
  - **BÆ°á»›c 5**: Redirect user vá» trang thÃ nh cÃ´ng

---

## ğŸ¯ CÃC TRÆ¯á»œNG Há»¢P THÃ€NH CÃ”NG VÃ€ THáº¤T Báº I

### **âœ… THÃ€NH CÃ”NG - KHÃ“A Há»ŒC MIá»„N PHÃ**

**Luá»“ng thá»±c thi:**
1. Frontend gá»i `handleEnroll(courseId)`
2. Backend kiá»ƒm tra `course.getPrice() == 0`
3. Táº¡o registration trá»±c tiáº¿p
4. Tráº£ vá» success message

**Code cháº¡y:**
- `CoursesPage.jsx:handleEnroll()` â†’ `courseService.handleCourseEnrollment()`
- `CourseRegistrationController:registerForCourse()` (dÃ²ng 100-110)
- `CourseRegistrationService:registerForCourse()` (dÃ²ng 25-85)

### **âœ… THÃ€NH CÃ”NG - KHÃ“A Há»ŒC CÃ“ PHÃ**

**Luá»“ng thá»±c thi:**
1. Frontend gá»i `handleEnroll(courseId)`
2. Backend tráº£ vá» `requiresPayment: true`
3. Frontend hiá»ƒn thá»‹ payment modal
4. User click thanh toÃ¡n â†’ táº¡o VNPay payment
5. Redirect Ä‘áº¿n VNPay portal
6. User thanh toÃ¡n thÃ nh cÃ´ng
7. VNPay callback â†’ táº¡o registration
8. Redirect vá» trang thÃ nh cÃ´ng

**Code cháº¡y:**
- `CoursesPage.jsx:handlePayment()` â†’ `courseService.processVNPayPayment()`
- `PaymentController:createVnPayPayment()` (dÃ²ng 35-90)
- `VnPayService:createPaymentUrl()` (dÃ²ng 15-70)
- `PaymentController:handleVnPayCallback()` (dÃ²ng 252-275)

### **âŒ THáº¤T Báº I - CÃC TRÆ¯á»œNG Há»¢P**

#### **1. User chÆ°a Ä‘Äƒng nháº­p**
- **Code cháº¡y**: `CoursesPage.jsx:handleEnroll()` (dÃ²ng 162-166)
- **Káº¿t quáº£**: Redirect Ä‘áº¿n `/login`

#### **2. KhÃ³a há»c khÃ´ng tá»“n táº¡i**
- **Code cháº¡y**: `CourseRegistrationController:registerForCourse()` (dÃ²ng 55-60)
- **Káº¿t quáº£**: Tráº£ vá» error "Course not found"

#### **3. User Ä‘Ã£ Ä‘Äƒng kÃ½**
- **Code cháº¡y**: `CourseRegistrationController:registerForCourse()` (dÃ²ng 75-80)
- **Káº¿t quáº£**: Tráº£ vá» error "User is already registered"

#### **4. KhÃ³a há»c Ä‘Ã£ Ä‘áº§y**
- **Code cháº¡y**: `CourseRegistrationController:registerForCourse()` (dÃ²ng 85-90)
- **Káº¿t quáº£**: Tráº£ vá» error "Course is full"

#### **5. KhÃ³a há»c khÃ´ng active**
- **Code cháº¡y**: `CourseRegistrationController:registerForCourse()` (dÃ²ng 65-70)
- **Káº¿t quáº£**: Tráº£ vá» error "Course is not available"

#### **6. Thanh toÃ¡n tháº¥t báº¡i**
- **Code cháº¡y**: `PaymentController:handleVnPayCallback()` (dÃ²ng 252-275)
- **Káº¿t quáº£**: Cáº­p nháº­t payment status = "FAILED", khÃ´ng táº¡o registration

---

## ğŸ”§ CÃC API ENDPOINTS CHÃNH

### **Course Registration APIs:**
- `POST /api/course-registrations/register/{courseId}` - ÄÄƒng kÃ½ khÃ³a há»c
- `POST /api/course-registrations/complete-enrollment/{courseId}` - HoÃ n thÃ nh Ä‘Äƒng kÃ½ sau thanh toÃ¡n
- `GET /api/course-registrations/check/{courseId}` - Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng kÃ½
- `DELETE /api/course-registrations/cancel/{courseId}` - Há»§y Ä‘Äƒng kÃ½

### **Payment APIs:**
- `POST /api/payments/vnpay/create` - Táº¡o VNPay payment
- `POST /api/payments/vnpay/callback` - Xá»­ lÃ½ callback tá»« VNPay
- `POST /api/payments/vnpay/return` - Xá»­ lÃ½ return tá»« VNPay

---

## ğŸ“Š DATABASE ENTITIES LIÃŠN QUAN

### **CourseRegistration Entity:**
- `userId` - ID cá»§a user Ä‘Äƒng kÃ½
- `courseId` - ID cá»§a khÃ³a há»c
- `registrationDate` - NgÃ y Ä‘Äƒng kÃ½
- `status` - Tráº¡ng thÃ¡i (ACTIVE, PENDING, CANCELLED)
- `isActive` - CÃ³ active khÃ´ng

### **Payment Entity:**
- `id` - Payment ID
- `userId` - ID cá»§a user thanh toÃ¡n
- `amount` - Sá»‘ tiá»n
- `currency` - Loáº¡i tiá»n (VND)
- `status` - Tráº¡ng thÃ¡i (PENDING, COMPLETED, FAILED)
- `paymentMethod` - PhÆ°Æ¡ng thá»©c thanh toÃ¡n (VNPAY)
- `paymentUrl` - URL thanh toÃ¡n VNPay

### **Course Entity:**
- `id` - Course ID
- `title` - TÃªn khÃ³a há»c
- `price` - GiÃ¡ (null = free, > 0 = paid)
- `currentParticipants` - Sá»‘ ngÆ°á»i Ä‘Ã£ Ä‘Äƒng kÃ½
- `maxParticipants` - Sá»‘ ngÆ°á»i tá»‘i Ä‘a
- `status` - Tráº¡ng thÃ¡i (open, closed)
- `isActive` - CÃ³ active khÃ´ng

---

## ğŸ¨ FRONTEND COMPONENTS

### **Payment Modal:**
- **File**: `CoursesPage.jsx` (dÃ²ng 200-230)
- **Chá»©c nÄƒng**: Hiá»ƒn thá»‹ thÃ´ng tin thanh toÃ¡n vÃ  nÃºt thanh toÃ¡n
- **Trigger**: Khi `response.requiresPayment = true`

### **Success/Error Messages:**
- **File**: `CoursesPage.jsx` (sá»­ dá»¥ng Ant Design message)
- **Chá»©c nÄƒng**: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng/tháº¥t báº¡i
- **Trigger**: Sau má»—i action Ä‘Äƒng kÃ½/thanh toÃ¡n

---

## ğŸ”’ SECURITY & VALIDATION

### **Authentication:**
- Táº¥t cáº£ API Ä‘á»u yÃªu cáº§u JWT token
- Sá»­ dá»¥ng `@PreAuthorize` annotation
- Kiá»ƒm tra user ownership

### **Validation:**
- Validate course tá»“n táº¡i vÃ  active
- Kiá»ƒm tra user chÆ°a Ä‘Äƒng kÃ½
- Validate course capacity
- Validate VNPay signature

### **Error Handling:**
- Try-catch blocks trong táº¥t cáº£ methods
- Logging chi tiáº¿t cho debugging
- User-friendly error messages

---

## ğŸ“ Káº¾T LUáº¬N

Luá»“ng Ä‘Äƒng kÃ½ khÃ³a há»c Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ xá»­ lÃ½ cáº£ khÃ³a há»c miá»…n phÃ­ vÃ  cÃ³ phÃ­ má»™t cÃ¡ch linh hoáº¡t. Há»‡ thá»‘ng sá»­ dá»¥ng VNPay lÃ m payment gateway chÃ­nh vÃ  cÃ³ cÆ¡ cháº¿ callback Ä‘á»ƒ xá»­ lÃ½ káº¿t quáº£ thanh toÃ¡n. ToÃ n bá»™ flow Ä‘Æ°á»£c báº£o máº­t báº±ng JWT authentication vÃ  cÃ³ validation Ä‘áº§y Ä‘á»§ á»Ÿ cáº£ frontend vÃ  backend.

---

## ğŸ” CHI TIáº¾T Bá»” SUNG - HIá»‚U SÃ‚U HÆ N Vá»€ Há»† THá»NG

### **ğŸ“Š Cáº¤U TRÃšC DATABASE CHI TIáº¾T**

#### **CourseRegistration Entity - Cáº¥u trÃºc Ä‘áº§y Ä‘á»§:**
```java
@Entity
@Table(name = "course_registrations")
public class CourseRegistration {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "user_id")
    private Long userId;
    
    @Column(name = "course_id")
    private Long courseId;
    
    private String status; // registered, attended, completed, cancelled
    
    @Column(name = "registration_date")
    private LocalDateTime registrationDate;
    
    @Column(name = "completion_date")
    private LocalDateTime completionDate;
    
    @Column(name = "cancelled_at")
    private LocalDateTime cancelledAt;
    
    @Column(name = "is_active")
    private Boolean isActive;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

**CÃ¡c tráº¡ng thÃ¡i registration:**
- `registered` - ÄÃ£ Ä‘Äƒng kÃ½ nhÆ°ng chÆ°a báº¯t Ä‘áº§u
- `attended` - Äang tham gia khÃ³a há»c
- `completed` - ÄÃ£ hoÃ n thÃ nh khÃ³a há»c
- `cancelled` - ÄÃ£ há»§y Ä‘Äƒng kÃ½

#### **Payment Entity - Cáº¥u trÃºc Ä‘áº§y Ä‘á»§:**
```java
@Entity
@Table(name = "payments")
public class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;
    
    @Column(nullable = false)
    private BigDecimal amount;
    
    @Column(length = 3)
    private String currency; // VND
    
    @Column(name = "payment_method", length = 50, nullable = false)
    private String paymentMethod; // VNPAY
    
    @Column(length = 20)
    private String status; // PENDING, SUCCESS, FAILED, REFUNDED
    
    @Column(name = "transaction_id", length = 100)
    private String transactionId; // VNPay transaction ID
    
    @Column(name = "payment_url", length = 1000)
    private String paymentUrl; // VNPay payment URL
    
    @Column(length = 500)
    private String description;
    
    @Column(name = "gateway_response", columnDefinition = "NVARCHAR(MAX)")
    private String gatewayResponse; // Raw VNPay response
    
    @Column(name = "error_message", length = 500)
    private String errorMessage;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "paid_at")
    private LocalDateTime paidAt;
    
    @Column(name = "refunded_at")
    private LocalDateTime refundedAt;
}
```

#### **Course Entity - CÃ¡c trÆ°á»ng quan trá»ng:**
```java
@Entity
@Table(name = "courses")
public class Course {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String title;
    
    @Column(columnDefinition = "TEXT")
    private String description;
    
    @Column(name = "max_participants")
    private Integer maxParticipants;
    
    @Column(name = "current_participants")
    private Integer currentParticipants;
    
    @Column(name = "price")
    private BigDecimal price; // null = free, > 0 = paid
    
    private String status; // open, closed, completed, cancelled
    
    @Column(name = "is_active")
    private Boolean isActive;
    
    @Column(name = "difficulty_level")
    private String difficultyLevel; // BEGINNER, INTERMEDIATE, ADVANCED
    
    @Column(name = "total_lessons")
    private Integer totalLessons;
    
    @Column(name = "certificate_enabled")
    private Boolean certificateEnabled;
    
    @Column(name = "enrollment_deadline")
    private LocalDateTime enrollmentDeadline;
}
```

### **ğŸ”„ LUá»’NG Xá»¬ LÃ CHI TIáº¾T HÆ N**

#### **1. FRONTEND - Xá»¬ LÃ ENROLLMENT (CoursePage.jsx)**

**Method `handleEnrollment()` (dÃ²ng 218-260):**
```javascript
const handleEnrollment = async () => {
  // 1. Kiá»ƒm tra authentication
  if (!authService.isAuthenticated()) {
    message.warning('Please login to enroll in this course');
    navigate('/login');
    return;
  }

  setEnrollmentLoading(true);
  try {
    // 2. PhÃ¢n loáº¡i khÃ³a há»c
    if (!course.price || course.price === 0) {
      // FREE COURSE - ÄÄƒng kÃ½ trá»±c tiáº¿p
      const response = await courseService.enrollInCourse(courseId);
      if (response.success) {
        message.success('Successfully enrolled in the course!');
        setIsEnrolled(true);
        await checkEnrollmentStatus();
      } else {
        message.error(response.error || 'Failed to enroll in course');
      }
    } else {
      // PAID COURSE - Táº¡o payment trÆ°á»›c
      const paymentResponse = await paymentService.createCoursePayment(
        courseId, 
        course.price, 
        `Enrollment for ${course.title}`
      );
      
      if (paymentResponse.success) {
        message.info('Redirecting to payment gateway...');
        paymentService.redirectToPayment(paymentResponse.paymentUrl);
      } else {
        message.error(paymentResponse.error || 'Failed to create payment');
      }
    }
  } catch (error) {
    console.error('Error during enrollment:', error);
    message.error('An error occurred during enrollment');
  } finally {
    setEnrollmentLoading(false);
  }
};
```

#### **2. BACKEND - VALIDATION CHI TIáº¾T**

**CourseRegistrationController - Validation logic:**
```java
@PostMapping("/register/{courseId}")
public ResponseEntity<?> registerForCourse(@PathVariable Long courseId, Authentication authentication) {
    try {
        // 1. Validate authentication
        if (authentication == null) {
            return ResponseEntity.badRequest().body(Map.of("error", "Authentication required"));
        }

        String username = authentication.getName();
        User user = authService.findByUsername(username);
        
        // 2. Validate course exists
        Optional<Course> courseOpt = courseService.getCourseById(courseId);
        if (courseOpt.isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("error", "Course not found"));
        }
        
        Course course = courseOpt.get();
        
        // 3. Validate course availability
        if (!course.getIsActive() || !"open".equals(course.getStatus())) {
            return ResponseEntity.badRequest().body(Map.of("error", "Course is not available for registration"));
        }
        
        // 4. Check enrollment deadline
        if (course.getEnrollmentDeadline() != null && 
            LocalDateTime.now().isAfter(course.getEnrollmentDeadline())) {
            return ResponseEntity.badRequest().body(Map.of("error", "Enrollment deadline has passed"));
        }
        
        // 5. Check if already registered
        boolean alreadyRegistered = courseRegistrationService.isUserRegisteredForCourse(user.getId(), courseId);
        if (alreadyRegistered) {
            return ResponseEntity.badRequest().body(Map.of("error", "User is already registered for this course"));
        }
        
        // 6. Check course capacity
        if (course.getCurrentParticipants() >= course.getMaxParticipants()) {
            return ResponseEntity.badRequest().body(Map.of("error", "Course is full"));
        }
        
        // 7. Handle free vs paid course
        if (course.getPrice() != null && course.getPrice().compareTo(BigDecimal.ZERO) > 0) {
            // PAID COURSE - Return payment required
            return ResponseEntity.ok(Map.of(
                "requiresPayment", true,
                "courseId", courseId,
                "courseName", course.getTitle(),
                "price", course.getPrice(),
                "currency", "VND",
                "message", "This course requires payment. Please proceed with payment.",
                "nextStep", "PAYMENT_REQUIRED"
            ));
        } else {
            // FREE COURSE - Direct registration
            CourseRegistration registration = courseRegistrationService.registerForCourse(user.getId(), courseId);
            return ResponseEntity.ok(Map.of(
                "success", true,
                "registration", registration,
                "message", "Successfully registered for free course",
                "nextStep", "ACCESS_GRANTED"
            ));
        }
    } catch (Exception e) {
        return ResponseEntity.internalServerError().body(Map.of("error", "Error registering for course: " + e.getMessage()));
    }
}
```

### **ğŸ’³ VNPAY INTEGRATION CHI TIáº¾T**

#### **1. Táº¡o Payment URL (VnPayService.java)**

**Method `createPaymentUrl()`:**
```java
public String createPaymentUrl(Map<String, String> params) {
    try {
        // 1. ThÃªm cÃ¡c tham sá»‘ báº¯t buá»™c cho VNPay
        params.put("vnp_Version", "2.1.0");
        params.put("vnp_Command", "pay");
        params.put("vnp_TmnCode", vnPayConfig.getTmnCode());
        params.put("vnp_CurrCode", "VND");
        params.put("vnp_Locale", "vn");
        params.put("vnp_ReturnUrl", vnPayConfig.getReturnUrl());
        params.put("vnp_IpAddr", "127.0.0.1");
        params.put("vnp_CreateDate", new SimpleDateFormat("yyyyMMddHHmmss").format(new Date()));
        
        // 2. Sáº¯p xáº¿p tham sá»‘ theo alphabet
        List<String> fieldNames = new ArrayList<>(params.keySet());
        Collections.sort(fieldNames);
        StringBuilder hashData = new StringBuilder();
        StringBuilder query = new StringBuilder();
        
        // 3. Build hash data vÃ  query string
        for (int i = 0; i < fieldNames.size(); i++) {
            String name = fieldNames.get(i);
            String value = params.get(name);
            if ((value != null) && (value.length() > 0)) {
                hashData.append(name).append('=').append(value);
                if (i < fieldNames.size() - 1) {
                    hashData.append('&');
                }
                
                query.append(URLEncoder.encode(name, StandardCharsets.US_ASCII)).append('=')
                     .append(URLEncoder.encode(value, StandardCharsets.US_ASCII));
                if (i < fieldNames.size() - 1) {
                    query.append('&');
                }
            }
        }
        
        // 4. Táº¡o chá»¯ kÃ½ HMAC SHA512
        String secureHash = hmacSHA512(vnPayConfig.getHashSecret(), hashData.toString());
        query.append("&vnp_SecureHash=").append(secureHash);
        
        // 5. Build final URL
        String finalUrl = vnPayConfig.getPaymentUrl() + "?" + query.toString();
        return finalUrl;
    } catch (Exception e) {
        throw new RuntimeException("Error creating VNPay payment URL", e);
    }
}
```

#### **2. Xá»­ lÃ½ Callback (PaymentController.java)**

**Method `handleVnPayCallback()`:**
```java
@PostMapping("/vnpay/callback")
public ResponseEntity<?> handleVnPayCallback(@RequestParam Map<String, String> params) {
    try {
        // 1. Validate VNPay signature
        String vnpSecureHash = params.get("vnp_SecureHash");
        if (!vnPayService.validateVnPayResponse(params, vnpSecureHash)) {
            return ResponseEntity.badRequest().body(Map.of("error", "Invalid VNPay signature!"));
        }
        
        // 2. Extract payment info
        String txnRef = params.get("vnp_TxnRef");
        String responseCode = params.get("vnp_ResponseCode");
        String status = responseCode.equals("00") ? "SUCCESS" : "FAILED";
        
        // 3. Find payment record
        Payment payment = paymentService.getPaymentById(Long.valueOf(txnRef)).orElse(null);
        if (payment == null) {
            return ResponseEntity.badRequest().body(Map.of("error", "Payment not found!"));
        }
        
        // 4. Update payment status
        payment.setStatus(status);
        payment.setTransactionId(params.get("vnp_TransactionNo"));
        payment.setGatewayResponse(params.toString());
        
        if (status.equals("SUCCESS")) {
            payment.setPaidAt(LocalDateTime.now());
            
            // 5. Extract courseId from orderInfo and create registration
            String orderInfo = params.get("vnp_OrderInfo");
            if (orderInfo != null && orderInfo.contains("Course ID: ")) {
                try {
                    String courseIdStr = orderInfo.substring(orderInfo.indexOf("Course ID: ") + 11);
                    if (courseIdStr.contains(" ")) {
                        courseIdStr = courseIdStr.substring(0, courseIdStr.indexOf(" "));
                    }
                    Long courseId = Long.valueOf(courseIdStr);
                    
                    // Create course registration
                    courseRegistrationService.registerForCourse(payment.getUser().getId(), courseId);
                } catch (Exception e) {
                    System.err.println("Error creating course registration: " + e.getMessage());
                }
            }
        }
        
        // 6. Save updated payment
        paymentService.createPayment(payment);
        
        return ResponseEntity.ok(Map.of("message", "Payment status updated", "status", status));
    } catch (Exception e) {
        return ResponseEntity.badRequest().body(Map.of("error", "Error processing VNPay callback: " + e.getMessage()));
    }
}
```

### **ğŸ¯ CÃC TRÆ¯á»œNG Há»¢P Äáº¶C BIá»†T**

#### **1. KhÃ³a há»c cÃ³ deadline Ä‘Äƒng kÃ½**
```java
// Kiá»ƒm tra enrollment deadline
if (course.getEnrollmentDeadline() != null && 
    LocalDateTime.now().isAfter(course.getEnrollmentDeadline())) {
    return ResponseEntity.badRequest().body(Map.of("error", "Enrollment deadline has passed"));
}
```

#### **2. KhÃ³a há»c cÃ³ yÃªu cáº§u Ä‘áº·c biá»‡t**
```java
// Kiá»ƒm tra prerequisites
if (course.getPrerequisites() != null && !course.getPrerequisites().isEmpty()) {
    // Logic kiá»ƒm tra user cÃ³ Ä‘á»§ Ä‘iá»u kiá»‡n khÃ´ng
    boolean meetsPrerequisites = checkUserPrerequisites(user, course.getPrerequisites());
    if (!meetsPrerequisites) {
        return ResponseEntity.badRequest().body(Map.of("error", "You don't meet the course prerequisites"));
    }
}
```

#### **3. Xá»­ lÃ½ refund/hoÃ n tiá»n**
```java
@PostMapping("/refund/{paymentId}")
public ResponseEntity<?> refundPayment(@PathVariable Long paymentId, @RequestBody Map<String, String> request) {
    try {
        String reason = request.get("reason");
        Payment payment = paymentService.getPaymentById(paymentId).orElse(null);
        
        if (payment == null) {
            return ResponseEntity.notFound().build();
        }
        
        // Update payment status
        payment.setStatus("REFUNDED");
        payment.setRefundedAt(LocalDateTime.now());
        payment.setRefundReason(reason);
        
        // Cancel course registration
        courseRegistrationService.cancelCourseRegistration(payment.getUser().getId(), courseId);
        
        paymentService.createPayment(payment);
        
        return ResponseEntity.ok(Map.of("message", "Payment refunded successfully"));
    } catch (Exception e) {
        return ResponseEntity.badRequest().body(Map.of("error", "Error refunding payment: " + e.getMessage()));
    }
}
```

### **ğŸ“± FRONTEND COMPONENTS CHI TIáº¾T**

#### **1. Payment Modal Component**
```javascript
// Payment Modal trong CoursesPage.jsx
const PaymentModal = ({ visible, paymentInfo, onOk, onCancel, loading }) => {
  return (
    <Modal
      title="Thanh toÃ¡n khÃ³a há»c"
      open={visible}
      onOk={onOk}
      onCancel={onCancel}
      confirmLoading={loading}
    >
      <div>
        <h3>{paymentInfo?.courseName}</h3>
        <p>GiÃ¡: {paymentInfo?.price?.toLocaleString('vi-VN')} VND</p>
        <p>PhÆ°Æ¡ng thá»©c: VNPay</p>
        <Alert
          message="ThÃ´ng bÃ¡o"
          description="Báº¡n sáº½ Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n trang thanh toÃ¡n VNPay Ä‘á»ƒ hoÃ n táº¥t giao dá»‹ch."
          type="info"
          showIcon
        />
      </div>
    </Modal>
  );
};
```

#### **2. Course Status Indicator**
```javascript
// Hiá»ƒn thá»‹ tráº¡ng thÃ¡i khÃ³a há»c
const CourseStatus = ({ course, isEnrolled, enrollmentStatus }) => {
  if (isEnrolled) {
    return <Tag color="green">ÄÃ£ Ä‘Äƒng kÃ½</Tag>;
  }
  
  if (course.currentParticipants >= course.maxParticipants) {
    return <Tag color="red">ÄÃ£ Ä‘áº§y</Tag>;
  }
  
  if (course.enrollmentDeadline && new Date() > new Date(course.enrollmentDeadline)) {
    return <Tag color="orange">Háº¿t háº¡n Ä‘Äƒng kÃ½</Tag>;
  }
  
  if (course.price && course.price > 0) {
    return <Tag color="blue">CÃ³ phÃ­</Tag>;
  }
  
  return <Tag color="green">Miá»…n phÃ­</Tag>;
};
```

### **ğŸ”§ CONFIGURATION VÃ€ ENVIRONMENT**

#### **1. VNPay Configuration**
```java
@Configuration
@ConfigurationProperties(prefix = "vnpay")
public class VnPayConfig {
    private String tmnCode;
    private String hashSecret;
    private String paymentUrl;
    private String returnUrl;
    private String ipnUrl;
    
    // Getters and setters
}
```

#### **2. Application Properties**
```properties
# VNPay Configuration
vnpay.tmnCode=DEMO
vnpay.hashSecret=SECRET_SHA256
vnpay.paymentUrl=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
vnpay.returnUrl=http://localhost:3000/payment-return
vnpay.ipnUrl=http://localhost:8080/api/payments/vnpay/callback

# Course Configuration
course.max-participants=100
course.enrollment-deadline-days=7
course.auto-approve-free=true
```

### **ğŸ“Š MONITORING VÃ€ LOGGING**

#### **1. Payment Logging**
```java
@Slf4j
public class PaymentService {
    public Payment createPayment(Payment payment) {
        log.info("Creating payment: userId={}, amount={}, description={}", 
                payment.getUser().getId(), payment.getAmount(), payment.getDescription());
        
        Payment savedPayment = paymentRepository.save(payment);
        
        log.info("Payment created: paymentId={}, status={}", 
                savedPayment.getId(), savedPayment.getStatus());
        
        return savedPayment;
    }
}
```

#### **2. Course Registration Metrics**
```java
@Service
public class CourseRegistrationMetricsService {
    public Map<String, Object> getRegistrationMetrics(Long courseId) {
        Map<String, Object> metrics = new HashMap<>();
        
        // Total registrations
        long totalRegistrations = courseRegistrationRepository.countByCourseId(courseId);
        metrics.put("totalRegistrations", totalRegistrations);
        
        // Active registrations
        long activeRegistrations = courseRegistrationRepository.countByCourseIdAndIsActiveTrue(courseId);
        metrics.put("activeRegistrations", activeRegistrations);
        
        // Completion rate
        long completedRegistrations = courseRegistrationRepository.countByCourseIdAndStatus(courseId, "completed");
        double completionRate = totalRegistrations > 0 ? (double) completedRegistrations / totalRegistrations : 0;
        metrics.put("completionRate", completionRate);
        
        // Revenue (for paid courses)
        BigDecimal totalRevenue = paymentRepository.sumAmountByCourseIdAndStatus(courseId, "SUCCESS");
        metrics.put("totalRevenue", totalRevenue);
        
        return metrics;
    }
}
```

### **ğŸš€ PERFORMANCE OPTIMIZATION**

#### **1. Database Indexing**
```sql
-- Indexes for better performance
CREATE INDEX idx_course_registrations_user_course ON course_registrations(user_id, course_id);
CREATE INDEX idx_course_registrations_status ON course_registrations(status);
CREATE INDEX idx_payments_user_status ON payments(user_id, status);
CREATE INDEX idx_payments_transaction_id ON payments(transaction_id);
CREATE INDEX idx_courses_status_active ON courses(status, is_active);
```

#### **2. Caching Strategy**
```java
@Service
@CacheConfig(cacheNames = "courses")
public class CourseService {
    @Cacheable(key = "#courseId")
    public Optional<Course> getCourseById(Long courseId) {
        return courseRepository.findById(courseId);
    }
    
    @CacheEvict(key = "#courseId")
    public void updateCourseParticipants(Long courseId) {
        // Update logic
    }
}
```

### **ğŸ”’ SECURITY ENHANCEMENTS**

#### **1. Rate Limiting**
```java
@RestController
@RateLimiter(name = "course-registration")
public class CourseRegistrationController {
    @PostMapping("/register/{courseId}")
    @RateLimiter(name = "course-registration", fallbackMethod = "rateLimitFallback")
    public ResponseEntity<?> registerForCourse(@PathVariable Long courseId, Authentication authentication) {
        // Registration logic
    }
    
    public ResponseEntity<?> rateLimitFallback(Long courseId, Authentication authentication) {
        return ResponseEntity.status(429).body(Map.of("error", "Too many registration attempts. Please try again later."));
    }
}
```

#### **2. Input Validation**
```java
@Validated
public class CourseRegistrationController {
    @PostMapping("/register/{courseId}")
    public ResponseEntity<?> registerForCourse(
        @PathVariable @Min(1) Long courseId,
        @Valid Authentication authentication) {
        // Registration logic
    }
}
```

---

## ğŸ“ Káº¾T LUáº¬N

Luá»“ng Ä‘Äƒng kÃ½ khÃ³a há»c Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ xá»­ lÃ½ cáº£ khÃ³a há»c miá»…n phÃ­ vÃ  cÃ³ phÃ­ má»™t cÃ¡ch linh hoáº¡t. Há»‡ thá»‘ng sá»­ dá»¥ng VNPay lÃ m payment gateway chÃ­nh vÃ  cÃ³ cÆ¡ cháº¿ callback Ä‘á»ƒ xá»­ lÃ½ káº¿t quáº£ thanh toÃ¡n. ToÃ n bá»™ flow Ä‘Æ°á»£c báº£o máº­t báº±ng JWT authentication vÃ  cÃ³ validation Ä‘áº§y Ä‘á»§ á»Ÿ cáº£ frontend vÃ  backend.

**Äiá»ƒm máº¡nh cá»§a há»‡ thá»‘ng:**
- âœ… Xá»­ lÃ½ linh hoáº¡t cáº£ khÃ³a há»c miá»…n phÃ­ vÃ  cÃ³ phÃ­
- âœ… TÃ­ch há»£p VNPay an toÃ n vá»›i signature validation
- âœ… Validation Ä‘áº§y Ä‘á»§ á»Ÿ nhiá»u táº§ng
- âœ… Error handling chi tiáº¿t
- âœ… Monitoring vÃ  logging tá»‘t
- âœ… Performance optimization vá»›i caching vÃ  indexing
- âœ… Security enhancements vá»›i rate limiting

**CÃ¡c tÃ­nh nÄƒng nÃ¢ng cao:**
- ğŸ”„ Auto-completion sau thanh toÃ¡n thÃ nh cÃ´ng
- ğŸ“Š Metrics vÃ  analytics cho course registration
- ğŸ”’ Rate limiting Ä‘á»ƒ trÃ¡nh spam
- ğŸ’° Refund mechanism
- ğŸ“± Responsive UI vá»›i Ant Design
- ğŸ¯ Prerequisites checking
- â° Enrollment deadline management 