# üîµ BACKEND - LU·ªíNG ƒê·∫∂T L·ªäCH H∆Ø·ªöNG D·∫™N CHI TI·∫æT

## üéØ TR√ÅCH NHI·ªÜM C·ª¶A B·∫†N

B·∫°n ch·ªãu tr√°ch nhi·ªám v·ªÅ **to√†n b·ªô lu·ªìng ƒë·∫∑t l·ªãch t∆∞ v·∫•n** trong h·ªá th·ªëng, bao g·ªìm:
- Qu·∫£n l√Ω cu·ªôc h·∫πn (Appointments)
- Qu·∫£n l√Ω th√¥ng tin chuy√™n gia t∆∞ v·∫•n (Consultants) 
- H·ªá th·ªëng ƒë√°nh gi√° sau bu·ªïi t∆∞ v·∫•n (Reviews)
- Notification v√† email th√¥ng b√°o

## üìÅ C√ÅC FILE B·∫†N C·∫¶N N·∫ÆMƒê∆Ø·ª¢C

### üéÆ **CONTROLLERS (API Endpoints)**

#### **1. AppointmentController.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/controller/AppointmentController.java`

**Ch·ª©c nƒÉng ch√≠nh:**
```java
// API endpoints m√† b·∫°n qu·∫£n l√Ω:
GET    /api/appointments              // L·∫•y danh s√°ch appointments
POST   /api/appointments              // T·∫°o appointment m·ªõi  
GET    /api/appointments/{id}         // L·∫•y chi ti·∫øt 1 appointment
PUT    /api/appointments/{id}         // C·∫≠p nh·∫≠t appointment
DELETE /api/appointments/{id}         // X√≥a appointment
PUT    /api/appointments/{id}/reschedule  // ƒê·ªïi l·ªãch h·∫πn
POST   /api/appointments/{id}/complete   // Ho√†n th√†nh bu·ªïi h·∫πn
```

**Lu·ªìng ho·∫°t ƒë·ªông:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ AppointmentCtrl  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ AppointmentSvc  ‚îÇ
‚îÇ   (React)       ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÇ  Response JSON   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÇ  Business Logic ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **2. ConsultantController.java** 
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/controller/ConsultantController.java`

**Ch·ª©c nƒÉng ch√≠nh:**
```java
// API endpoints cho consultant management:
GET    /api/consultants                    // L·∫•y danh s√°ch chuy√™n gia
GET    /api/consultants/{id}               // Chi ti·∫øt chuy√™n gia
GET    /api/consultants/{id}/availability  // L·∫•y l·ªãch tr·ªëng c·ªßa chuy√™n gia  
GET    /api/consultants/{id}/appointments  // L·ªãch h·∫πn c·ªßa chuy√™n gia
PUT    /api/consultants/{id}/schedule      // C·∫≠p nh·∫≠t l·ªãch l√†m vi·ªác
```

#### **3. ReviewController.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/controller/ReviewController.java`

**Ch·ª©c nƒÉng ch√≠nh:**
```java
// API endpoints cho review system:
POST   /api/reviews                 // T·∫°o ƒë√°nh gi√° m·ªõi
GET    /api/reviews/appointment/{id} // L·∫•y review c·ªßa appointment
GET    /api/reviews/consultant/{id}  // L·∫•y t·∫•t c·∫£ review c·ªßa consultant
PUT    /api/reviews/{id}            // C·∫≠p nh·∫≠t review
DELETE /api/reviews/{id}            // X√≥a review
```

### ‚öôÔ∏è **SERVICES (Business Logic)**

#### **AppointmentService.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/service/AppointmentService.java`

**C√°c method quan tr·ªçng b·∫°n c·∫ßn hi·ªÉu:**

```java
// T·∫°o appointment m·ªõi v·ªõi validation
public AppointmentDTO createAppointment(CreateAppointmentRequest request) {
    // 1. Validate user c√≥ quy·ªÅn ƒë·∫∑t l·ªãch kh√¥ng
    // 2. Check consultant c√≥ available kh√¥ng  
    // 3. Validate th·ªùi gian ƒë·∫∑t (kh√¥ng ƒë∆∞·ª£c qu√° kh·ª©, kh√¥ng tr√πng l·ªãch)
    // 4. T·∫°o appointment entity
    // 5. Save v√†o database
    // 6. G·ª≠i notification
    // 7. Return DTO
}

// C·∫≠p nh·∫≠t appointment 
public AppointmentDTO updateAppointment(Long id, UpdateAppointmentRequest request) {
    // 1. Check ownership (ch·ªâ user t·∫°o ho·∫∑c consultant ƒë∆∞·ª£c ph√©p update)
    // 2. Validate new data
    // 3. Update entity  
    // 4. Save v√† return
}

// Reschedule appointment
public AppointmentDTO rescheduleAppointment(Long id, RescheduleRequest request) {
    // 1. Check appointment status (ch·ªâ SCHEDULED m·ªõi reschedule ƒë∆∞·ª£c)
    // 2. Validate new time slot
    // 3. Check consultant availability  
    // 4. Update appointment
    // 5. Send notification v·ªÅ thay ƒë·ªïi
}

// Ho√†n th√†nh appointment
public AppointmentDTO completeAppointment(Long id) {
    // 1. Check ch·ªâ consultant m·ªõi c√≥ th·ªÉ complete
    // 2. Update status th√†nh COMPLETED
    // 3. Trigger review process
    // 4. Update consultant statistics
}
```

**Validation Rules quan tr·ªçng:**
```java
// Th·ªùi gian validation
- appointmentTime ph·∫£i > hi·ªán t·∫°i + 1 gi·ªù
- appointmentTime ph·∫£i trong gi·ªù l√†m vi·ªác (8:00-17:00)  
- appointmentTime kh√¥ng ƒë∆∞·ª£c tr√πng v·ªõi appointment kh√°c c·ªßa consultant
- appointmentTime ph·∫£i l√† multiple c·ªßa 30 ph√∫t (VD: 9:00, 9:30, 10:00...)

// Permission validation  
- USER ch·ªâ c√≥ th·ªÉ t·∫°o appointment cho ch√≠nh h·ªç
- CONSULTANT c√≥ th·ªÉ view appointment c·ªßa h·ªç v√† update status
- ADMIN/MANAGER c√≥ th·ªÉ view/update t·∫•t c·∫£ appointments
```

### üóÉÔ∏è **ENTITIES (Database Models)**

#### **Appointment.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/entity/Appointment.java`

**C·∫•u tr√∫c Entity:**
```java
@Entity
@Table(name = "appointments")
public class Appointment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne  // Many appointments -> One user
    @JoinColumn(name = "user_id")
    private User user;          // Ng∆∞·ªùi ƒë·∫∑t l·ªãch
    
    @ManyToOne  // Many appointments -> One consultant  
    @JoinColumn(name = "consultant_id")
    private User consultant;    // Chuy√™n gia t∆∞ v·∫•n
    
    private LocalDateTime appointmentTime;  // Th·ªùi gian h·∫πn
    private String appointmentType;         // Lo·∫°i t∆∞ v·∫•n (ONLINE/OFFLINE)
    private String status;                  // SCHEDULED/COMPLETED/CANCELLED
    private String notes;                   // Ghi ch√∫ c·ªßa user
    private String consultantNotes;         // Ghi ch√∫ c·ªßa consultant
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // Getters, setters, constructors...
}
```

**Appointment Status Flow:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SCHEDULED  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  COMPLETED  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   REVIEWED  ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ    ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ
       ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CANCELLED  ‚îÇ    ‚îÇ  RESCHEDULED‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Review.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/entity/Review.java`

```java
@Entity  
@Table(name = "reviews")
public class Review {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @OneToOne  // One review -> One appointment
    @JoinColumn(name = "appointment_id")
    private Appointment appointment;
    
    @ManyToOne  // Many reviews -> One user (reviewer)
    @JoinColumn(name = "user_id") 
    private User user;
    
    @ManyToOne  // Many reviews -> One consultant (ƒë∆∞·ª£c review)
    @JoinColumn(name = "consultant_id")
    private User consultant;
    
    private Integer rating;        // 1-5 stars
    private String comment;        // N·ªôi dung ƒë√°nh gi√°
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### üíæ **REPOSITORIES (Data Access)**

#### **AppointmentRepository.java**
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/repository/AppointmentRepository.java`

**Custom Query Methods:**
```java
public interface AppointmentRepository extends JpaRepository<Appointment, Long> {
    
    // T√¨m appointments c·ªßa 1 user
    List<Appointment> findByUserIdOrderByAppointmentTimeDesc(Long userId);
    
    // T√¨m appointments c·ªßa 1 consultant
    List<Appointment> findByConsultantIdOrderByAppointmentTimeDesc(Long consultantId);
    
    // T√¨m appointments theo status
    List<Appointment> findByStatusOrderByAppointmentTimeDesc(String status);
    
    // Check conflict - t√¨m appointment tr√πng th·ªùi gian v·ªõi consultant
    @Query("SELECT a FROM Appointment a WHERE a.consultant.id = :consultantId " +
           "AND a.appointmentTime = :appointmentTime AND a.status = 'SCHEDULED'")
    Optional<Appointment> findConflictingAppointment(
        @Param("consultantId") Long consultantId, 
        @Param("appointmentTime") LocalDateTime appointmentTime
    );
    
    // Th·ªëng k√™ appointments theo th√°ng
    @Query("SELECT MONTH(a.appointmentTime) as month, COUNT(a) as count " +
           "FROM Appointment a WHERE YEAR(a.appointmentTime) = :year " +
           "GROUP BY MONTH(a.appointmentTime)")
    List<Object[]> getAppointmentStatsByMonth(@Param("year") int year);
    
    // T√¨m available time slots cho consultant
    @Query("SELECT a.appointmentTime FROM Appointment a WHERE a.consultant.id = :consultantId " +
           "AND DATE(a.appointmentTime) = DATE(:date) AND a.status = 'SCHEDULED'")
    List<LocalDateTime> getBookedTimeSlots(
        @Param("consultantId") Long consultantId,
        @Param("date") LocalDate date
    );
}
```

#### **ReviewRepository.java**  
**ƒê∆∞·ªùng d·∫´n:** `backend/src/main/java/com/drugprevention/drugbe/repository/ReviewRepository.java`

```java
public interface ReviewRepository extends JpaRepository<Review, Long> {
    
    // T√¨m review c·ªßa appointment
    Optional<Review> findByAppointmentId(Long appointmentId);
    
    // L·∫•y t·∫•t c·∫£ reviews c·ªßa consultant v·ªõi pagination
    Page<Review> findByConsultantIdOrderByCreatedAtDesc(
        Long consultantId, Pageable pageable
    );
    
    // T√≠nh rating trung b√¨nh c·ªßa consultant
    @Query("SELECT AVG(r.rating) FROM Review r WHERE r.consultant.id = :consultantId")
    Double getAverageRatingByConsultantId(@Param("consultantId") Long consultantId);
    
    // ƒê·∫øm s·ªë l∆∞·ª£ng reviews c·ªßa consultant
    Long countByConsultantId(Long consultantId);
}
```

## üîÑ LU·ªíNG X·ª¨ L√ù CHI TI·∫æT

### **1. LU·ªíNG T·∫†O APPOINTMENT M·ªöI**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. User Request ‚îÇ 
‚îÇ (Frontend)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ POST /api/appointments
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Controller   ‚îÇ
‚îÇ Nh·∫≠n request    ‚îÇ 
‚îÇ Validate JWT    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ CreateAppointmentRequest DTO
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Service      ‚îÇ
‚îÇ Business Logic  ‚îÇ
‚îÇ - Check user    ‚îÇ
‚îÇ - Validate time ‚îÇ 
‚îÇ - Check conflict‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ Appointment Entity
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Repository   ‚îÇ
‚îÇ Save to DB      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ Saved Entity
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Response     ‚îÇ
‚îÇ AppointmentDTO  ‚îÇ
‚îÇ + Notification  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Chi ti·∫øt t·ª´ng b∆∞·ªõc:**

**B∆∞·ªõc 1 - Frontend Request:**
```javascript
// Frontend g·ª≠i request
const createAppointment = async (appointmentData) => {
    const response = await axios.post('/api/appointments', {
        consultantId: 14,
        appointmentTime: '2024-12-25T10:00:00',
        appointmentType: 'ONLINE',
        notes: 'C·∫ßn t∆∞ v·∫•n v·ªÅ v·∫•n ƒë·ªÅ stress'
    }, {
        headers: { Authorization: `Bearer ${token}` }
    });
    return response.data;
};
```

**B∆∞·ªõc 2 - Controller Processing:**
```java
@PostMapping
@PreAuthorize("hasRole('USER') or hasRole('CONSULTANT')")
public ResponseEntity<AppointmentDTO> createAppointment(
    @RequestBody CreateAppointmentRequest request,
    Authentication authentication
) {
    // Extract user t·ª´ JWT token
    String username = authentication.getName();
    
    // Validate request data
    if (request.getConsultantId() == null || request.getAppointmentTime() == null) {
        return ResponseEntity.badRequest().build();
    }
    
    // Call service
    AppointmentDTO appointment = appointmentService.createAppointment(request, username);
    
    return ResponseEntity.ok(appointment);
}
```

**B∆∞·ªõc 3 - Service Business Logic:**
```java
public AppointmentDTO createAppointment(CreateAppointmentRequest request, String username) {
    // 1. T√¨m user t·ª´ username
    User user = userRepository.findByUsername(username)
        .orElseThrow(() -> new RuntimeException("User not found"));
    
    // 2. T√¨m consultant
    User consultant = userRepository.findById(request.getConsultantId())
        .orElseThrow(() -> new RuntimeException("Consultant not found"));
    
    // 3. Validate consultant role
    if (!consultant.getRole().getName().equals("CONSULTANT")) {
        throw new RuntimeException("Selected user is not a consultant");
    }
    
    // 4. Validate appointment time
    LocalDateTime appointmentTime = request.getAppointmentTime();
    if (appointmentTime.isBefore(LocalDateTime.now().plusHours(1))) {
        throw new RuntimeException("Appointment must be at least 1 hour in the future");
    }
    
    // 5. Check time conflict
    Optional<Appointment> conflict = appointmentRepository.findConflictingAppointment(
        consultant.getId(), appointmentTime
    );
    if (conflict.isPresent()) {
        throw new RuntimeException("Time slot is already booked");
    }
    
    // 6. Create new appointment
    Appointment appointment = new Appointment();
    appointment.setUser(user);
    appointment.setConsultant(consultant);
    appointment.setAppointmentTime(appointmentTime);
    appointment.setAppointmentType(request.getAppointmentType());
    appointment.setNotes(request.getNotes());
    appointment.setStatus("SCHEDULED");
    appointment.setCreatedAt(LocalDateTime.now());
    
    // 7. Save to database
    Appointment saved = appointmentRepository.save(appointment);
    
    // 8. Send notifications
    sendAppointmentNotification(saved);
    
    // 9. Convert to DTO v√† return
    return convertToDTO(saved);
}
```

### **2. LU·ªíNG RESCHEDULE APPOINTMENT**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User wants to   ‚îÇ
‚îÇ change time     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ PUT /api/appointments/{id}/reschedule
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Validate        ‚îÇ
‚îÇ - Ownership     ‚îÇ
‚îÇ - New time      ‚îÇ
‚îÇ - Availability  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Update DB       ‚îÇ
‚îÇ Send notification‚îÇ
‚îÇ to both parties ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **3. LU·ªíNG COMPLETE APPOINTMENT**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Consultant      ‚îÇ
‚îÇ completes       ‚îÇ 
‚îÇ session         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ POST /api/appointments/{id}/complete
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Update status   ‚îÇ
‚îÇ to COMPLETED    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚ñº  
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Trigger review  ‚îÇ
‚îÇ request to user ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîê SECURITY & VALIDATION

### **Authentication & Authorization Rules:**

```java
// Trong AppointmentController
@PreAuthorize("hasRole('USER') or hasRole('CONSULTANT')")  // T·∫°o appointment
@PreAuthorize("hasRole('CONSULTANT')")                     // Complete appointment  
@PreAuthorize("@appointmentService.isOwnerOrConsultant(#id, authentication.name)")  // Update appointment
```

### **Validation Logic:**

```java
// Time validation
private void validateAppointmentTime(LocalDateTime appointmentTime) {
    // 1. Kh√¥ng ƒë∆∞·ª£c trong qu√° kh·ª©
    if (appointmentTime.isBefore(LocalDateTime.now())) {
        throw new RuntimeException("Cannot schedule appointment in the past");
    }
    
    // 2. Ph·∫£i c√°ch √≠t nh·∫•t 1 gi·ªù
    if (appointmentTime.isBefore(LocalDateTime.now().plusHours(1))) {
        throw new RuntimeException("Appointment must be at least 1 hour in advance");
    }
    
    // 3. Trong gi·ªù l√†m vi·ªác (8:00 - 17:00)
    int hour = appointmentTime.getHour();
    if (hour < 8 || hour >= 17) {
        throw new RuntimeException("Appointments only available between 8:00 AM and 5:00 PM");
    }
    
    // 4. Ch·ªâ 30-minute slots (9:00, 9:30, 10:00...)
    if (appointmentTime.getMinute() != 0 && appointmentTime.getMinute() != 30) {
        throw new RuntimeException("Appointments must be scheduled on 30-minute intervals");
    }
}

// Ownership validation
public boolean isOwnerOrConsultant(Long appointmentId, String username) {
    Appointment appointment = appointmentRepository.findById(appointmentId)
        .orElse(null);
    if (appointment == null) return false;
    
    return appointment.getUser().getUsername().equals(username) ||
           appointment.getConsultant().getUsername().equals(username);
}
```

## üìß NOTIFICATION SYSTEM

### **Email Templates:**

**1. Appointment Created:**
```java
private void sendAppointmentCreatedEmail(Appointment appointment) {
    // G·ª≠i cho user
    emailService.sendEmail(
        appointment.getUser().getEmail(),
        "X√°c nh·∫≠n ƒë·∫∑t l·ªãch t∆∞ v·∫•n",
        buildAppointmentCreatedTemplate(appointment)
    );
    
    // G·ª≠i cho consultant  
    emailService.sendEmail(
        appointment.getConsultant().getEmail(),
        "L·ªãch h·∫πn m·ªõi ƒë∆∞·ª£c ƒë·∫∑t",
        buildNewAppointmentTemplate(appointment)
    );
}
```

**2. Appointment Rescheduled:**
```java
private void sendRescheduleNotification(Appointment appointment, LocalDateTime oldTime) {
    String message = String.format(
        "L·ªãch h·∫πn ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi t·ª´ %s sang %s", 
        oldTime.format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm")),
        appointment.getAppointmentTime().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"))
    );
    
    // G·ª≠i cho c·∫£ 2 b√™n
    notificationService.sendToUser(appointment.getUser().getId(), message);
    notificationService.sendToUser(appointment.getConsultant().getId(), message);
}
```

## üß™ TESTING GUIDELINES

### **Unit Tests c·∫ßn vi·∫øt:**

```java
@Test
void testCreateAppointment_Success() {
    // Given
    CreateAppointmentRequest request = new CreateAppointmentRequest();
    request.setConsultantId(14L);
    request.setAppointmentTime(LocalDateTime.now().plusDays(1));
    request.setAppointmentType("ONLINE");
    
    // Mock dependencies
    when(userRepository.findByUsername("testuser")).thenReturn(Optional.of(user));
    when(userRepository.findById(14L)).thenReturn(Optional.of(consultant));
    when(appointmentRepository.findConflictingAppointment(any(), any())).thenReturn(Optional.empty());
    when(appointmentRepository.save(any())).thenReturn(savedAppointment);
    
    // When
    AppointmentDTO result = appointmentService.createAppointment(request, "testuser");
    
    // Then
    assertThat(result).isNotNull();
    assertThat(result.getStatus()).isEqualTo("SCHEDULED");
    verify(appointmentRepository).save(any(Appointment.class));
}

@Test  
void testCreateAppointment_TimeConflict() {
    // Given - c√≥ appointment tr√πng gi·ªù
    when(appointmentRepository.findConflictingAppointment(any(), any()))
        .thenReturn(Optional.of(existingAppointment));
    
    // When & Then
    assertThrows(RuntimeException.class, () -> {
        appointmentService.createAppointment(request, "testuser");
    });
}
```

### **Integration Tests:**

```java
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class AppointmentControllerIT {
    
    @Test
    @WithMockUser(username = "testuser", roles = "USER")
    void testCreateAppointment_E2E() throws Exception {
        // Test complete flow t·ª´ controller ƒë·∫øn database
        mockMvc.perform(post("/api/appointments")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.status").value("SCHEDULED"));
    }
}
```

## üêõ COMMON ISSUES & TROUBLESHOOTING

### **1. Time Zone Issues:**
```java
// Lu√¥n s·ª≠ d·ª•ng UTC trong database, convert khi c·∫ßn
LocalDateTime utcTime = appointmentTime.atZone(ZoneId.systemDefault())
    .withZoneSameInstant(ZoneOffset.UTC)
    .toLocalDateTime();
```

### **2. Concurrent Booking:**
```java
// S·ª≠ d·ª•ng database lock ƒë·ªÉ tr√°nh race condition
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT a FROM Appointment a WHERE a.consultant.id = :consultantId")
List<Appointment> findByConsultantIdWithLock(@Param("consultantId") Long consultantId);
```

### **3. Data Validation:**
```java
// Validate input ·ªü nhi·ªÅu layer
@Valid @RequestBody CreateAppointmentRequest request  // Controller layer
// + Service layer validation
// + Database constraints
```

## üìà PERFORMANCE OPTIMIZATION

### **Database Indexing:**
```sql
-- Indexes c·∫ßn t·∫°o cho performance
CREATE INDEX idx_appointment_user_id ON appointments(user_id);
CREATE INDEX idx_appointment_consultant_id ON appointments(consultant_id);  
CREATE INDEX idx_appointment_time ON appointments(appointment_time);
CREATE INDEX idx_appointment_status ON appointments(status);
CREATE UNIQUE INDEX idx_appointment_consultant_time ON appointments(consultant_id, appointment_time) 
    WHERE status = 'SCHEDULED';
```

### **Caching Strategy:**
```java
// Cache consultant availability
@Cacheable(value = "consultant-availability", key = "#consultantId + '_' + #date")
public List<LocalTime> getAvailableTimeSlots(Long consultantId, LocalDate date) {
    // Implementation
}
```

## üéØ NEXT STEPS & IMPROVEMENTS

1. **Real-time notifications** v·ªõi WebSocket
2. **Calendar integration** (Google Calendar, Outlook)  
3. **Video call integration** cho online consultations
4. **Automated reminders** tr∆∞·ªõc appointment
5. **Analytics dashboard** cho consultants
6. **Mobile push notifications**

---

**üî• L·ªúI KHUY√äN QUAN TR·ªåNG:**
- Lu√¥n test thoroughly v·ªõi c√°c edge cases v·ªÅ th·ªùi gian
- Logging chi ti·∫øt cho appointment operations  
- Handle timezone carefully khi deploy production
- Monitor database performance v·ªõi appointment queries
- Backup strategy cho appointment data 